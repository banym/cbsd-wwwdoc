<!--#set var="uri" value="$DOCUMENT_URI" -->
<!--# include file="_start.html" -->
<!--# include file="currentver.html" -->
<h1><span>CBSD и Qemu User mode</span></h1>
<div class="block">
	<p>Имея установленный в мастер-ноде QEMU, собранный с дополнительными таргетами <strong>user mode</strong>  (\*-user) ( <a href="https://wiki.freebsd.org/QemuUserModeHowTo" target="_blank">https://wiki.freebsd.org/QemuUserModeHowTo</a> ), вы можете создавать клетки с альтернативной архитектурой, отличной от архитектуры мастер хоста. При этом, эмуляция будет достигаться через эмулятор Qemu, работающий в прозрачном режиме - если бинарный файл имеет отличную от родной архитектуру, он может выполнен в этой системе без необходимости устанавливать целостную виртуальную машину Qemu.</p>
	<p>Для того, чтобы <strong>cbsd</strong> могла создавать такие клетки, выполняемый бинарный файл Qemu, обеспечивающий ту или иную архитектуру в <strong>usermode</strong>, должнен быть собран статически, поскольку этот файл будет помещен внутри клетки.</p>
	<p>Зачем это вообще может быть полезно?</p>
	<p>В первую очередь, это достаточно простой способ проверить работоспособность бинарной FreeBSD программы определенной архитектуры в родном окружении, при этом вам не потребуется искать bootable-дистрибутив и устанавливать FreeBSD нужной архитектуры на отдельный носитель с нуля.</p>
	<p>Во-вторых, многие владельцы ARM-based устройств страдают от отсутствия репозитория <strong>pkg</strong> для ARM архитектур, а собирать пакеты непосредственно на крайне ограниченных по мощностям ресурсах самих Embedded ARM-based устройств - мягко скажем, довольно грустная операция.</p>
	<p>ARM-based jail, запущенный на мощной x86-64 системе позволит вам собрать необходимые пакеты, которые вы сможете уже проинсталлировать на Embedded устройстве через стандартный <strong>pkg</strong> в бинарном виде.</p>
	<p>По результатам тестирования, потеря скорости в работе под QEMU эмулятором колеблется от 3% до 25% что, например, в сравнении с мощностями таких устройств как <strong>RPi-B</strong>, современный x86-десктоп в любом случае значительно быстрее.</p>
	<p>В данный момент протестирована работа клеток на <strong>armv6</strong> архитектуре и <strong>mips64</strong></p>
	<p><em>Замечание</em>: ввиду того, что программы будут выполняться под qemu, на них распространяется стандартное ограничение оперативной памяти в 128MB, что может приводить к падениям некоторых пузатых процессов. Я не нашел на скорую руку как через user mode утилиты  (qemu-arm, qemu-mips64) указать <strong>-m XX</strong>, поэтому  вы можете просто откорректировать нужный вам объем в файле vl.c QEMU, указав например </p>
	<pre class="brush:bash;ruler:true;">
		#define DEFAULT_RAM_SIZE 512
	</pre>
	<p>вместо 128.</p>
	<p class="text-center"><img src="/img/cbsd_with_qemu.png" /></p>
<!--# include file="_end.html" -->