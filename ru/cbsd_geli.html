<!--#set var="uri" value="$DOCUMENT_URI" -->
<!--# include file="_start.html" -->
	<h1><span>Шифрованные образы с&nbsp;cbsd geli</span></h1>
	<div class="block">
		<p>Имеются ситуации, когда информацию, размещенную на&nbsp;жестком диске сервера желательно хранить в&nbsp;зашифрованном виде.  Например, вы&nbsp;устанавливаете сервер с&nbsp;важной информацией в&nbsp;любом чужом датацентре. Бывают реальные случаи (автор с&nbsp;таким случаем знаком не&nbsp;по&nbsp;наслышке), когда недобросовестные сотрудники датацентра могут на&nbsp;несколько минут выключить ваш сервер под любым предлогом (перерывы на&nbsp;технические работы&nbsp;&mdash; не&nbsp;редкость),  сделать образ жесткого диска и&nbsp;включить обратно, что для вас будет выглядеть как перезагрузка сервера, в&nbsp;то&nbsp;время как вся информация стала находится у&nbsp;сторонних лиц. Либо, вы&nbsp;арендуете VDS/VPS, где чужой для вас не&nbsp;только датацентр, но&nbsp;и&nbsp;сам сервер и&nbsp;носитель информации.</p>
		<p>В&nbsp;подобных случаях прибегают к&nbsp;шифрованию тех данных, утечка которых нежелательна. В&nbsp;данный момент, CBSD имеет скрипт-враппер <strong>geli</strong> для работы с зашифрованными образами через GELI&nbsp;фреймворк. Также, как перед использованием <strong>cbsd</strong> крайне желательно ознакомится с&nbsp;оригинальным man на&nbsp;<a href="http://www.freebsd.org/cgi/man.cgi?query=jail&sektion=8" target="_blank">jail</a>, так и&nbsp;в&nbsp;данном контексте настоятельно рекомендуется ознакомиться со&nbsp;следующей информацией:</p>
		<ul>
			<li><a href="http://www.freebsd.org/cgi/man.cgi?query=geli&sektion=8" target="_blank">man geli</a></li>
			<li>пункт 18.14.2&nbsp;в <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/disks-encrypting.html" target="_blank">Encrypting Disk Partitions</a></li>
		</ul>
		<p>перед использованием <strong>cbsd geli</strong>.</p>
		<p>Работа с&nbsp;GELI предполагается по&nbsp;следующему сценарию:</p>
		<ul>
			<li>Криптованию подлежат только выборочные данные. Поскольку операция шифрования зависима в&nbsp;первую очередь от&nbsp;вашего процессора, потребление ресурсов всегда будет выше, а&nbsp;I/O&nbsp;&mdash; ниже при работе с&nbsp;данными на&nbsp;зашифрованном разделе. Вместо того, чтобы шифровать всю клетку, вы&nbsp;можете предпочесть зашифровать только важные данны внутри клетки, например: <em>/root</em>, <em>/home/user</em>, <em>/var/db/mysql</em>. <em>/usr/local/etc</em> и&nbsp;тд, при этом логи, база или весь сторонний софт, который вы&nbsp;установили через pkg/ports&nbsp;&mdash; можно оставить незашифрованными. Также, кроме шифрования данных клеток, вы&nbsp;можете захотеть шифровать каталог <em>$workdir/.rssh</em>, в&nbsp;котором cbsd хранит ID_RSA ключи удаленных машин и&nbsp;<em>$workdir/.ssh</em> в&nbsp;котором расположен собственный ключ от&nbsp;пользователя cbsd.</li>
			<li>Каждому зашифрованному устройству назначается свой собственный пароль/фраза для дешифрации. Однако, все они будут хранится на&nbsp;системном образе <strong>CBSD</strong>, который в&nbsp;свою очередь будет зашифрован master-ключем. Другими словами, поскольку вы&nbsp;доверяете вашему собственному серверу, то&nbsp;при необходимости включить тот или иной зашифрованный раздел, <strong>CBSD</strong> будет сама применять нужный ключ при подключении того или иного криптованного образа. При этом ключи для их&nbsp;дешифровки хранится в&nbsp;файле, который в&nbsp;свою очередь зашифрованным вашим паролем и&nbsp;активируется вручную.</li>
		</ul>
		<p>Для общего понимания, обозначим следующие условности:</p>
		<ul>
			<li><strong>${dbdir}</strong>&mdash;&nbsp;каталог <em>$workdir/var/db</em>, где <em>workdir</em>&nbsp;&mdash; куда проинициализирована cbsd. Например: <em>/usr/jails/var/db</em></li>
			<li><strong>MASTER_GELI</strong>&mdash;&nbsp;зашифрованный вашим паролем образ, в&nbsp;котором <strong>CBSD</strong> будет искать ключи для всех остальных geli attach операций. Расположен на&nbsp;файловой системе в&nbsp;виде файла <em>${dbdir}/master_geli.img</em></li>
			<div class="warning">
				<p><strong>ВНИМАНИЕ!</strong> Удаление или порча этогоо файла сделает невозможным подключение всех остальные криптованных образов автоматически и&nbsp;подмонтировать эти образы будет возможно только если вы&nbsp;помните, какому образу какой пароль вы&nbsp;назначали на&nbsp;<strong>cbsd geli mode=init file=</strong> стадии. В&nbsp;связи с&nbsp;этим, регулярно делайте резервные копии этого файла.</p>
			</div>
			<li><strong>каталог ключей</strong>&mdash;&nbsp;смонтированный образ <strong>MASTER_GELI</strong> файла в&nbsp;каталог <em>${dbdir}/geli</em>. Во&nbsp;избежание возможной порчи из-за некорректного размонтирования (сбой сервера, пропажа питания, некорректное выключение), данный ресурс подключен в&nbsp;режиме <em>Read-only</em> и&nbsp;переходит в&nbsp;режим записи только при модификациях.</p></li>
		</ul>
	</div>
	<h2><a name="geliinit">Инициализация cbsd geli</a></h2>
	<div class="block">
		<p>Для начала работы с&nbsp;шифрованными разделами на&nbsp;ноде, необходимо создать <strong>MASTER_GELI</strong> файл и&nbsp;придумать для него пароль. Используйте сложный пароль, поскольку он&nbsp;открывает доступ для всех остальных ключей. Для инициалиации служит команда <strong>cbsd geli mode=initmaster</strong>.</p>
		<pre class="brush:bash;ruler:true;">
			% cbsd geli mode=initmaster
			Initialization. Please set master password for geli base image
			Enter new passphrase:
		</pre>
		<p>Вторичный запуск этой команды выдаст вопрос на&nbsp;ввод пароля, либо команда отработает без какого-либо вывода, если данный файл уже проиницализирован и&nbsp;подмонтирован в&nbsp;$dbdir/geli. Успешная инициализация файла подключает содержимое файла в&nbsp;каталог $dbdir/geli, давай остальным скриптам доступ к&nbsp;ключам остальных образов.</p>
		<p><em>Примечание</em>:</p>
		<p>По-умолчанию, образ для хранения ключей создается равным 5Mb и&nbsp;используется алгоритм AES-XTS. Данная настройка находится в&nbsp;файле <em>${workdir}/etc/defaults/geli.conf</em> и&nbsp;может быть изменена через соответствующие записи в&nbsp;<em>$workdir/etc/geli.conf</em></p>
	</div>
	<h2><a name="imageinit">Инициализация geli-образов для использования cbsd</a></h2>
	<div class="block">
		<p>GELI образ должен быть приинициализирован до&nbsp;того, как вы&nbsp;примонтируете его и&nbsp;начнете писать информацию. Для инициализации служит команда:</p>
		<pre class="brush:bash;ruler:true;">
			% cbsd geli mode=init file=/path/to/file
		</pre>
		<p>При первом запуске geli init для файла /path/to/file будет выполнены следующие шаги:</p>
		<ul>
			<li>1) если в&nbsp;путь к&nbsp;файлу начинается с&nbsp;$workdir (например, cbsd установлена в&nbsp;/usr/jails, а&nbsp;cbsd init выполняется с&nbsp;параметрами <strong>mode=init file=/usr/jails/jails-system/jail1/root.img</strong>), то&nbsp;логикой скрипта путь $workdir  удаляется из&nbsp;пути и&nbsp;эта локация используется для генерации имени файла ключа через md5. Подобная операция необходима для тех случаев, если вы&nbsp;будете мигрировать клетку с&nbsp;одной ноды на&nbsp;другую и&nbsp;различными $workdir&nbsp;&mdash; если не&nbsp;отрезать workdir, то&nbsp;md5 имена ключей станут разными.  Если&nbsp;же путь задается для файла, не&nbsp;входящего в&nbsp;$workdir, путь остается без изменений.</li>
			<li>2) скрипт <strong>cbsd geli</strong> запрашивает от&nbsp;вас пароль для файла в&nbsp;переменной file= и&nbsp;сохраняет его в&nbsp;файле $dbdir/geli/md5_от_результата_шага_1</li>
			<li>3) выполняет <strong>geli attach</strong> с&nbsp;этим ключем и&nbsp;выводит имя получившегося устройства, например:
			<pre class="brush:bash;ruler:true;">
				/dev/md1.eli
			</pre>
			который вы&nbsp;уже можете отформатировать и&nbsp;заполнить теми данными, которые будут зашифрованы.</li>
		</ul>
		<p>Как и&nbsp;в&nbsp;случае с&nbsp;initmaster, если запускается init на&nbsp;файл вторично&nbsp;&mdash; система без вопросов его презентует, если ключ уже имеется.</p>
	</div>
	<h2><a name="imageinit">Использование fstab клеток для составления списка криптованных имиджей и&nbsp;точек монтирования</a></h2>
	<div class="block">
		<p> // WIP //</p>
	</div>
	<div class="block">
		<p class="text-center">Схематично, взаимодействие с&nbsp;CBSD GELI скрипта с&nbsp;системой выглядит примерно следующем образом:</p>
		<p class="text-center"><img src="/img/cbsd_geli1.png" /></p>
	</div>

<!--# include file="_end.html" -->
