<!--# include file="_start.html" -->
<div class="content">
	<h2><a name="knowit"><span>Что необходимо знать о cbsd</cpan></h2>
	<div class="block">
		<p><strong>cbsd</strong> представляет из себя дополнительный уровень абстракции над <a href="http://www.freebsd.org/cgi/man.cgi?query=jail&apropos=0&sektion=0&manpath=FreeBSD+9.2-RELEASE&arch=default&format=html">Jail framework</a> и частью функционала FreeBSD.</p>
		<p>Некоторый список этого функционала, задействованного в cbsd:</p>
		<ul>
			<li>vnet (VIMAGE)</li>
			<li>zfs</li>
			<li>racct/rctl</li>
			<li>ipfw</li>
			<li>pf</li>
			<li>carp</li>
			<li>hastd</li>
			<li>auditd</li>
		</ul>
		<p>Многие эти подсистемы не имеют непосредственного отношения к <b>jail</b>, однако, позволяют <b>cbsd</b> (являющейся связующим звеном между этими компонентами) предоставить администратору системы более расширенную и комплексную систему для решения задач. Если вы столкнулись с какой-либо проблемой (например не стартует или пропала клетка, не знаете где лежат данные клетки и настройки cbsd, возникает какая-то ошибка в конфигурации и тд), то ниже дана информация, описывающая структуру cbsd более детально.</p>
		<p>Во-первых, глава <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/jails.html">FreeBSD Jails</a>  обязательна для изучения, чтобы понимать, что представляет из себя jail в обычном виде.</p>
		<p>Во-вторых, полезно знать о иерархии файловой системы <b>cbsd</b>. Условимся в документации использовать следующие именования и значения:</p>
		<ul>
			<li><b>Нода</b> - физический сервер/единица ресурсов.</li>
			<li><b>Клетка</b> - Jail, изолированное окружение со своим набором ПО/сервисом. В них могут быть как серверные компоненты (DNS, Apache/nginx, postfix) так и графические окружения. Клетки делятся на два типа - сервисные и целостные.</li>
			<li><b>Облако</b> - Ферма/кластер, связанные между собой нодами, одноранговая полноправная сеть (каждая нода может делать задачи другой посредством <b>cbsd</b>)</li>
			<li><b>База</b> - в контексте cbsd - копия базовой системы FreeBSD.</li>
			<li><b>cbsd</b> - некая сущность, имеющая контроль над нодой(ами) и определенными подсистемами FreeBSD, способная предоставлять упрощенные и единые действия (API) над нодами, клетками и предоставляющая ACL и разграничение прав для клиентов cbsd</li>
			<li><b>$workdir</b> - рабочий каталог cbsd на нодах, инициализируется через cbsd initenv при первом запуске. Обычно <b>/usr/jails</b>.</li>
			<li><b>$jname</b> - Какое-то имя клетки, учавствующей в примере.</li>
		</ul>
	</div>
	<div class="block">
		<p>Вся рабочие данные <b>cbsd</b> находится в каталоге <b>$workdir</b> (например <i>/usr/jails</i>), он же является домашним каталогом для пользователя <b>cbsd</b> и вы всегда можете быстро перейти в него по команде:</p>
		<pre>
		% cd ~cbsd
		</pre>
		<p>Самые важные данные находятся в каталоге <b>$workdir/jails-data/$jname</b>, поскольку это непосредственно корень файловой системы клетки с именем </b>$jname</b>, если клетка создана с флагом <b>baserw=1</b>, либо содержит те данные клетки, которые накладываются на стандартный <b>$workdir/basejail/$basename</b> в каталоге <b>${workdir}/jails</b></p>
		<p>Учитывая, что базу вы всегда можете получить через сборку исходных кодов или скачав с репозитория, то для миграции cbsd jail на любой другой проект по управлению клетками самое главное - это иметь консистентные данные в этом каталоге.</p>
		<p><i>Примечение:</i> если использовать тип клетки md, то в каталог $workdir/jails-data/$jname будет содержать имидж клетки.</p>
		<p><i>Примечание2:</i>Если вы используете ZFS и обнаружили, кто данные каталоги пусты (при остановленной клетке), проверьте вывод команды:</p>
		<pre>
		% zfs list
		</pre>
		<p>cbsd может размонтировать данные когда клетка неактивна. Для доступа к данным выполните:</p>
		<pre>
		% zfs mount соответствующая_$jname_файловая_система
		</pre>
		<p>Второе по значимости в иерархии каталогов cbsd могут выступать конфигурационные файлы для создания клетки, которые располагаются в каталоге <b>$workdir/var/db/</b>. Все параметры клетки сохраняются в SQLite3 файле, на который указывает симлинк ${workdir}/var/db/local.sqlite в таблице jails. Схема таблицы описана в файле <i>${workdir}/share/local-jails.schema</i> Например, для того чтобы посмотреть все клетки на ноде и их ip адреса:</p>
		<pre>
		% sqlite3 /usr/jails/var/db/local.sqlite "select jname,ip4_addr from jails"
		</pre>
		<p>Когда клетка запускается, cbsd генерирует jail.conf файл из данных SQLite3 командой</p>
		<pre>
		% cbsd jmkrcconf jname=jailname
		</pre>
		<p>Вы можете использовать эту команду, если хотите перейти с <b>cbsd</b> обратно на базовый вариант (потеряв функционал <b>cbsd</b>)</p>
		<p>Каталог <b>$workdir/jails-system/</b> служит в качестве дополнительного места хранения служебной информации к клеткам, например в нем могут быть конфигураторы сервисов, файл с описанием клетки, статистика по трафику и потребляемым ресурсам и тд.</p>
		<p>Служебная информация для нужд самой cbsd находится в каталоге $workdir/db. Например, информация о списке добавленных нодах, инвентаризация как локальной ноды так и удаленных и тд.</p>
		<p>Важными в плане безопасности, является каталоги <b>${workdir}/.rssh</b> и <b>${workdir}/.ssh</b>, в котором находятся приватные RSA ключи от пользователя cbsd с удаленных нодах и с локальной соответственно. Следите за тем, чтобы данные этих каталогов были недоступены для других пользователей системы. По-умолчанию, читать ключ может только системный пользователь cbsd.</p>
		<p>И наконец в-третьих, обязательно ознакомьтесь с модификациями, которые готовит cbsd в вашей конфигурации: <a href="custom_freecbsd.html">Модификации, которые выполняют скрипты cbsd в FreeBSD</a></p>
	</div>
	<h2><a name="hier"><span>Краткая сводка по иерархии cbsd</cpan></h2>
	<div class="block">
		<table border=1>
			<tr><td>${workdir}/.rssh/</td><td>Каталог для хранения приватных ключей удаленных нод. Файлы добавляются и удаляются через команду <b>cbsd node</b></td></tr>
			<tr><td>${workdir}/.ssh</td><td>Здесь хранится приватный и публичный ключ непосредственно данной ноды. Формируется на этапе инициализации при команде cbsd initenv. Именно отсюда будут забирать публичный ключ удаленные хосты по команде cbsd node mode=add. Имя, заданное на этапе initenv в вопросе nodename должен совпадать с написанием  имени в аргументе node= при команде cbsd node mode=add. Имя файла ключа является md5 суммой от этого имени.</td></tr>
			<tr><td>${workdir}/basejail</td><td>Здесь хранятся готовые к использованию базы и ядра FreeBSD (результат cbsd buildworld/buildkernel, cbsd installworld/installkernel или cbsd repo action=get sources=base/kernel)</td></tr>
			<tr><td>${workdir}/etc</td><td>Конфигурационные файлы, необходимые для работы cbsd</td></tr>
			<tr><td>${workdir}/export</td><td>Каталог по-умолчанию, в который будет сохраняться экспортированная в файл клетка (при команде cbsd jexport jname=$jname, в этом каталоге появится файл $jname.img)</td></tr>
			<tr><td>${workdir}/import</td><td>Каталог по-умолчанию, из которого будет импортирован jail (при cbsd jimport jname=$jname, будет развернута клета $jname)</td></tr>
			<tr><td>${workdir}/jails</td><td>В данном каталоге находятся точка монтирования корня для jail-ов, использующих baserw=0.</td></tr>
			<tr><td>${workdir}/jails-data</td><td>В этом каталоге лежат данные клетки. Именно этим местам необходим бекап для сохранности данных клетки. Также, если клетка использует baserw=1, эти каталоги являются корнем клетки при ее старте</td></tr>
			<tr><td>${workdir}/jails-fstab</td><td>fstab файл для клеток. Синтаксис обычный для FreeBSD за тем лишь исключением, что путь к точке монтирования пишется относительно корня jail (запись <b>/usr/ports /usr/ports nullfs rw 0 0</b> в файле fstab.$jname означает, что из мастер-ноды каталог /usr/ports будет примонтирован при запуске в ${workdir}/jails/$jname/usr/ports)</td></tr>
			<tr><td>${workdir}/jails-system</td><td>Этот каталог может содержать какие-то вспомогательные скрипты, относящиеся к клетке (например скрипты-wizard-ы для настройки, конфигураторы и пр) а также, сохраняется трафик клетки, если используется ipfw и ее описание. Данный каталог учавствует при jimport/jexport операциях и мигрировании клеток</td></tr>
			<tr><td>${workdir}/var</td><td>Каталог который содержит различную системную информацию cbsd. Например, в ${workdir}/var/db находится инвентаризация локальных и удаленных нод если они были добавлены</td></tr>
			<tr><td>/usr/local/cbsd</td><td>Копия оригинальных файлов cbsd устанавливаемая портом. Также, содержит рабочие скрипты в каталоге <b>sudoexec</b></td></tr>
		</table>
	</div>
	<h2><a name="traffic"><span>Подсчет трафика jail</cpan></h2>
	<div class="block">
		<p>В данный момент, для подсчета трафика jail используются правила <b>count</b> у фильтра <b>ipfw</b>. <b>cbsd</b> назначает для счетчиков номера правил из диапазона <b>99 - 2000</b> (можно изменить в cbsd.conf). Поэтому будьте внимательны и следите за тем, чтобы ваши правила IPFW следовали после указанного диапазона.</p>
	</div>
	<h2><a name="color"><span>ANSII Color</span></h2>
	<div class="block">
		<p>По-умолчанию, <b>cbsd</b> выводит текст в цвете (используя управляющие последовательности ANSII). Если по каким-то причинам цвет неприятен, либо вы используете вывод от утилит cbsd в своих скриптах, которым последовательность ANSII мешает, вы можете запретить цвет через переменную окружения NOCOLOR=1. Например, команда</p>
		<pre>
		% env NOCOLOR=1 cbsd jls
		</pre>
		запретит использование цвета при выводе заголовка.
	</div>
	<h2><a name="troubles"><span>Если что-то пошло не так</span></h2>
	<div class="block">
		<p>В случае, если при выполнении утилит <b>cbsd</b> возникают ошибки, рекомендуется оформить проблему в баг-трекере проекта: <a href="https://github.com/olevole/cbsd/issues">cbsd issues</a> или сообщить об ошибке по email: <b>cbsd</b> <i>at</i> <b>bsdstore.ru</b></p>
		<p>Делайте резервные копии каталогов ${workdir}/var/db, ${workdir}/var/db, ${workdir}/jails-fstab, ${workdir}/jails-system и, конечно же, данные клеток в каталоге ${workdir}/jails-data</p>
		<p>Если вы будете восстанавливать Jail из бекапа, вам потребуется файл ${workdir}/jails-system/${jname}/rc.conf_${jname} - после того как каталоги jails-data и jails-fstab клетки вы вернете обратно в структуру $workdir каталогов, скопируйте данный rc.conf_${jname} в каталог ${workdir}/jails-rcconf/ - после этого, по команде</p>
		<pre>
		% cbsd jls
		</pre>
		<p>Jail будет выводится в списке в статусе Unregister. По команде</p>
		<pre>
		% cbsd jregister jname=$jname
		</pre>
		<p>вы вернете клетку в общий пул и рабочее состояние.</p>
	</div>
</div>
<!--# include file="_end.html" -->
