<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
<HEAD>
<META http-equiv="content-type" content="text/html; charset=UTF-8">
<LINK rel="shortcut icon" href="favicon.ico">

<title>CBSD&nbsp;&mdash; FreeBSD jails management tools</title>
<meta name="keywords" content="jail ip alias, jail zfs, jail interface, jail baserw, jail mount ports, jail auto start, jail vnet, jail vimage, jail resolv.conf, jail cpuset, jail setfib"/>
<meta name="description" content="jail ip alias, jail zfs, jail interface, jail baserw, jail mount ports, jail auto start, jail vnet, jail vimage, jail resolv.conf, jail cpuset, jail setfib" />
</HEAD>
<!--# include file="/html/cbsdmenu_ru.html" -->
<body>
<!--# include file="/html/currentver.html" -->
<center><FONT face="verdana,arial,helvetica" size="+1">параметры клеток cbsd</font></center>
<FONT face="verdana,arial,helvetica" size="-1">
<br><br>
<body>
<p>Каждая клетка cbsd имеет свой набор настроек, который используется при старте, останове и&nbsp;работе клеток.
<br><br>
Часть из&nbsp;них указывается на&nbsp;этапе создания клетки, остальные вы&nbsp;сможете поменять через команду
<pre>
% cbsd jconfig jname=jname
</pre>

Очень немногие параметры в&nbsp;данный момент можно изменить на-лету.
<br><br>
Здесь дана краткая информация стандартных параметров.
<hr>
<pre>
jname="jail1";
</pre>
Непосредственно, уникальное имя клетки. Это то&nbsp;имя, которое видно по&nbsp;команде <b>cbsd jls</b> или в&nbsp;списке инвентаризации нод.
Данное поле нельзя менять вручную. Если вы&nbsp;хотите поменять имя клетки, воспользуйтесь командой <b>cbsd jrename</b>, поскольку имя клетки
используется во&nbsp;многих настройках и&nbsp;путях на&nbsp;файловой системе.
<hr>
<pre>
path="/usr/jails/jails/jail1";
</pre>
Указывает на&nbsp;путь, который будет использован в&nbsp;качестве корня при старте клетки. Вышеописанная конфигурация характерна для клеток,
которые имеют настройку baserw равную&nbsp;0, тоесть, база которых смонтирована в&nbsp;только-чтение.
<br>В&nbsp;этом случае, алгоритм работы jstart будет следующим:
<br>
<br>1) смонтировать через nullfs базу определенной версии (см. ниже) в&nbsp;каталог /usr/jails/jails/$jname
<br>2) на&nbsp;уже смонтированную базу $workdir/jails/jails/$jname подмонтировать каталоги, относящиеся непосредственно к&nbsp;клетке (из&nbsp;каталога $workdir/jails-data/$jname), обычно уже в&nbsp;режиме записи.
<br>3) стартовать клетку с&nbsp;корнем $workdir/jails/jails/$jname
<br>
<br>Если&nbsp;же baserw=1, то&nbsp;nullfs не&nbsp;исползуется, и&nbsp;клетка сразу стартует с&nbsp;каталогом $workdir/jails-data/$jname в&nbsp;качестве корня. В&nbsp;этих случаях, параметр path обычно выглядит как
<br>
<br>path=&quot;/usr/jails/jails-data/jail1-data&quot;;
<hr>
<pre>
host_hostname="jail1.my.domain";
</pre>
FQDN, полное имя клетки. Данное поле нельзя менять вручную. Если вы&nbsp;хотите поменять имя клетки, воспользуйтесь командой <b>cbsd jrename</b>
<hr>
<pre>
ip4_addr="10.0.0.5/24";
</pre>
IP&nbsp;адрес клетки. Если планируется использовать несколько&nbsp;IP адресов, они записываются через запятую:
<br>
<br>ip4_addr=&quot;10.0.0.5/24,192.168.0.2/30,54:04:a6:b2:11:c4/64&Prime;;
<hr>
<pre>
mount_devfs="1";
</pre>
Смонтировать&nbsp;ли в&nbsp;клетку файловую систему devfs (каталог /dev). Как правило, большинство сервисов без этого просто не&nbsp;смогут работать.
<hr>
<pre>
allow_mount="1";
</pre>
Можно&nbsp;ли пользователям или сервисам, находящимся внутри клетки монтировать другие файловые системы.
<hr>
<pre>
allow_devfs="0";
</pre>
Можно&nbsp;ли пользователям или сервисам, находящимся внутри клетки монтировать devfs
<hr>
<pre>
allow_nullfs="0";
</pre>
Можно&nbsp;ли пользователям или сервисам, находящимся внутри клетки монтировать nullfs
<hr>
<pre>
mount_fstab="/usr/jails/jails-fstab/fstab.jail1";
</pre>
Путь к&nbsp;файлу, содержащему список каталогов или файловых систем, которые будут примонтированы в&nbsp;клетку при ее&nbsp;запуске
<hr>
<pre>
arch="amd64";
</pre>
Архитектура клетки (и&nbsp;соответственно, базы из&nbsp;$workdir/basejail)
<hr>
<pre>
mkhostsfile="1";
</pre>
Поправить&nbsp;ли в&nbsp;/etc/hosts клетки запись вида
<br>$ip4_add $jname $jname.my.domain
<br>в&nbsp;соответствии с&nbsp;IP адресом и&nbsp;именем (FQDN) клетки
<hr>
<pre>
devfs_ruleset="4";
</pre>
набор правил devfs, которые будут применены на&nbsp;файловую систему devfs в&nbsp;каталоге /dev клетки (список правил в&nbsp;файле /etc/devfs.rules мастер-ноды)
<hr>
<pre>
interface="auto";
</pre>
Запись управляет поведением по&nbsp;автоматическому созданию и&nbsp;удалению&nbsp;IP адресов на&nbsp;интерфейсе либо использованию ранее установленных.
<br>
Значение <b>auto</b> означает, что cbsd сама выберет интерфейс, на&nbsp;котором создать&nbsp;IP адрес клетки. 
Например: имеется нода с&nbsp;двумя интерфейсами. На&nbsp;интерфейсе igb0 установлен&nbsp;IP и&nbsp;подсеть 10.0.0.2/24 и&nbsp;при этом
шлюз по-умолчанию для сервера является 10.0.0.1, в&nbsp;следствии чего igb0 является сетевой картой, через который идет трафик по-умолчанию. 
<br>На&nbsp;интерфейсе 
igb1 прописан IP/подсеть 192.168.0.1/24. В&nbsp;случае, если в&nbsp;rc.conf клетки ip4_addr принимает значение 192.168.0.{1-255}, то&nbsp;cbsd автоматически выберет
интерфейс igb1 для прописывания&nbsp;IP клетки. 
<br>Если ни&nbsp;на&nbsp;одном из&nbsp;интерфейсов нет подсети, в&nbsp;которую входит&nbsp;IP клетки, будет выбран интерфейс по-умолчанию.
<br>Также, значение может быть выставлено в&nbsp;имя интерфейса, если вы&nbsp;не&nbsp;хотите использовать поиск наиболее подходящего интерфейса. Например запись
<br>
<br>interface=&quot;igb0&Prime;
<br>
<br>пропишет&nbsp;IP адрес клетки на&nbsp;интерфейсе igb0.
<br>
<br>Также как и&nbsp;при запуске, когда cbsd пропишет на&nbsp;интерфейсе нужные клетке&nbsp;IP, при остановке их&nbsp;снимет с&nbsp;интерфейса. Поэтому, будьте предельно аккуратны&nbsp;&mdash; 
если вы&nbsp;пропишите по&nbsp;ошибке в&nbsp;качестве&nbsp;IP клетки адрес непосредственно ноды, то&nbsp;при остановке клетки cbsd выполнит
<br>
<br>ifconfig <iface> <ip> -alias
<br>
<br>и&nbsp;нода будет потеряна по&nbsp;сети.
<br>
<br>Для того, чтобы пресечь управление&nbsp;IP адресами, параметр interface можно закомментировать или удалить, либо значение оставить пустым:
<br>
<br>interface=&quot;&quot;
<br>
В&nbsp;этом случае, cbsd сразу будет запускать jail с&nbsp;соответствующим&nbsp;IP, подразумевая, что он&nbsp;уже инициализирован. Такая ситуация может быть необходима, когда
сервер имеет лишь 1&nbsp;IP адрес, а&nbsp;вы&nbsp;планируете запустить jail (или несколько клеток) на&nbsp;одном имеющимся&nbsp;IP, но&nbsp;с&nbsp;сервисами внутри, которые не&nbsp;конфликтуют
по&nbsp;портам.
<br>Например, имея 1&nbsp;IP адрес, вы&nbsp;можете запустить одну клетку с&nbsp;WEB сервером на&nbsp;80&nbsp;порту, другую клетку с&nbsp;почтовым сервером на&nbsp;25&nbsp;порту и&nbsp;тд.
<hr>
<pre>
ver="10.0";
</pre>
Версия базы для клетки. Имеет прямое отношение к&nbsp;версии FreeBSD. Так, если в&nbsp;rc.conf клетки установлены параметры
<br>
<br>arch=&quot;amd64&Prime;
<br>ver=&quot;10.0&Prime;
<br>baserw=0
<br>
<br>то&nbsp;при старте клетки в&nbsp;качестве базы будет выбрана ${workdir}/basejail/base_amd64_10.0.
<br>
<br>Если стоит 
<br>
<br>arch=&quot;i386&Prime;
<br>ver=&quot;9.1&Prime;
<br>baserw=0
<br>
<br>то, соответственно, будет использован ${workdir}/basejail/base_i386_9.1.
<br>
<br>Таким образом вы&nbsp;можете переключать версию базы с&nbsp;одной версии на&nbsp;другую
<br>
<br>В&nbsp;случае, когда baserw=1, подразумевается что вся база уже была проинициализирована и&nbsp;наполнила собой ${workdir}/jails-data/$jname-data, поэтому эти параметры
роли не&nbsp;играют
<hr>
<pre>
basename="";
</pre>
<br>Имя базы. Вы&nbsp;можете собирать кастомизированные base, например собрать минимальное окружение и&nbsp;разместить его в 
<br>$workdir/base_lite_amd64_9.2
<br>
<br>Для того, чтобы указать cbsd что нужно смонтировать данный каталог, basename должен содержать префикс lite:
<br>
<br>basename=&quot;lite&quot;;
<hr>
<pre>
baserw="0";
</pre>
Если&nbsp;1, подразумевается что клетка имеет свою собственную базовую файловую систему и&nbsp;имеет в&nbsp;нее запись. 
<br>Как правило, этот параметр задается на&nbsp;этапе создания клетки. Если&nbsp;же вы&nbsp;создали изначально клетку baserw=0 (readonly), но&nbsp;хотите
перевести ее&nbsp;в&nbsp;режим baserw=1, вам предварительно необходимо скопировать все базовые файлы в&nbsp;каталог $workdir/jails-data/$jname-data. Например:
<br>
<br>cd&nbsp;/usr/jails/basejail/base_amd64_10/
<br>pax -p eme -X -rw . /usr/jails/jails-data/jail1-data
<br>
<br>либо, если вы&nbsp;собрали в&nbsp;мастер-ноде объектные файлы:
<br>make -C /usr/src installworld DESTDIR=&quot;/usr/jails/jails-data/jail1-data&quot;
<br>
<br>Таким&nbsp;же образом на&nbsp;данном этапе, предполагается обновлять клетки, работающие в&nbsp;режиме baserw=1, тк&nbsp;каждая клетка имеет персональную копию базы.
<br>Напротив, при использовании baserw=0, вы&nbsp;можете использовать лишь одну копию базы, которая монтируется через nullfs в&nbsp;read-only всем клеткам. 
<br>
<br>Вы&nbsp;можете иметь одну базу (например минимального объема с&nbsp;именем lite) на&nbsp;несколько десятков клеток, размещенную на&nbsp;md-ramfs для ускорения работы базовых утилит в&nbsp;клетках.
<br>
<br>Помимо этого, с&nbsp;baserw=0&nbsp;вы имеете возможность обновлять версию баз меньшими затратами.
<br>
<br>Кроме этого, смонтированная база в&nbsp;режиме read-only дает вам дополнительную безопасность, если вашу клетку взломали и&nbsp;попробуют модифицировать файлы системы&nbsp;&mdash; это у&nbsp;взломщиков просто не&nbsp;получится.
<hr>
<pre>
mount_src="0";
</pre>
Смонтировать&nbsp;ли в&nbsp;/usr/src каталог клетки исходные коды FreeBSD в&nbsp;read-only, если они есть
<hr>
<pre>
mount_obj="";
</pre>
Смонтировать&nbsp;ли в&nbsp;/usr/obj каталог клетки объектные файлы FreeBSD в&nbsp;read-only, если они есть
<hr>
<pre>
mount_kernel="0";
</pre>
Смонтировать&nbsp;ли в&nbsp;/boot/kernel ядро FreeBSD. Это может быть полезно, к&nbsp;примеру, для работы CTF-информации, необходимую для работы DTRACE.
<hr>
<pre>
mount_ports="1";
</pre>
Смонтировать&nbsp;ли в&nbsp;/usr/ports порты из&nbsp;мастер-ноды в&nbsp;readonly. Вы&nbsp;можете иметь одно дерево портов на&nbsp;всю ноду, которое развернуть в&nbsp;/usr/ports каталоге мастер-ноды и&nbsp;которое подмонтировано во&nbsp;все клетки.
<br>Для того, чтобы одновременная копмиляция одного и&nbsp;того&nbsp;же порта не&nbsp;конфликтовала в&nbsp;двух и&nbsp;более клетках, в&nbsp;/etc/make.conf параметр WRKDIRPREFIX ставится в&nbsp;альтернативное место, например /tmp (если клетка 
имеет applytpl=1, это происходит автоматически)
<hr>
<pre>
astart="1";
</pre>
Следует&nbsp;ли запускать клетку автоматически при старте ноды. Если astart=0, клетка не&nbsp;запустится сама с&nbsp;перезагрузки мастер-хоста.
<hr>
<pre>
vnet="0";
</pre>
<hr>
<pre>
applytpl="1";
</pre>
Применить&nbsp;ли некоторые модификации в&nbsp;конфигурации клетки: выставить pkg.conf, внести записи в&nbsp;/etc/hosts и&nbsp;тд.
<hr>
<pre>
mdsize="0";
</pre>
<hr>
<pre>
rcconf="/usr/jails/jails-rcconf/rc.conf_jail1";
</pre>
<hr>
<pre>
floatresolv="1";
</pre>
Автоматически поправить /etc/resolv.conf , назначив автоматически в&nbsp;качестве первичного nameserver кеширующий named в&nbsp;мастер-ноде, остальные nameserver&nbsp;&mdash; из&nbsp;инвентаризации ноды.
<hr>
<pre>
exec_start="/bin/sh /etc/rc";
</pre>
<hr>
<pre>
exec_stop="/bin/sh /etc/rc.shutdown";
</pre>
<hr>
<pre>
exec_poststart="";
</pre>
Выполнить команду внутри клетки после ее&nbsp;старта. Можно задавать несколько скриптов нумерую параметры:
<br>
<br>exec_poststart0=&quot;date &gt; /tmp/start1.txt&quot;;
<br>exec_poststart1=&quot;date &gt; /tmp/start2.txt&quot;;
<br>..
<hr>
<pre>
exec_poststop="";
</pre>
Выполнить команду внутри клетки после ее&nbsp;останова. Можно задавать несколько скриптов нумерую параметры:
<br>
<br>exec_poststop0=&quot;date &gt; /tmp/stop1.txt&quot;;
<br>exec_poststop1=&quot;date &gt; /tmp/stop2.txt&quot;;
<br>..
<hr>
<pre>
exec_prestart="";
</pre>
Выполнить команду внутри клетки перед ее&nbsp;стартом. Можно задавать несколько скриптов нумерую параметры:
<br>
<br>exec_prestart0=&quot;date &gt; /tmp/prestart1.txt&quot;;
<br>exec_prestart1=&quot;date &gt; /tmp/prestart2.txt&quot;;
<br>..
<hr>
<pre>
exec_prestop="";
</pre>
Выполнить команду внутри клетки перед ее&nbsp;остановом. Можно задавать несколько скриптов нумерую параметры:
<br>
<br>exec_prestop0=&quot;date &gt; /tmp/prestop1.txt&quot;;
<br>exec_prestop1=&quot;date &gt; /tmp/prestop2.txt&quot;;
<br>..
<hr>
<pre>
exec_master_poststart="";
</pre>
Аналогичное поведение exec_poststart, за&nbsp;исключением того что команда выполняется в&nbsp;мастер системе (будьте внимательны, небезопасно)
<hr>
<pre>
exec_master_poststop="";
</pre>
Аналогичное поведение exec_poststop, за&nbsp;исключением того что команда выполняется в&nbsp;мастер системе (будьте внимательны, небезопасно)
<hr>
<pre>
exec_master_prestart="";
</pre>
Аналогичное поведение exec_prestart, за&nbsp;исключением того что команда выполняется в&nbsp;мастер системе (будьте внимательны, небезопасно)
<hr>
<pre>
exec_master_prestop="";
</pre>
Аналогичное поведение exec_prestop, за&nbsp;исключением того что команда выполняется в&nbsp;мастер системе (будьте внимательны, небезопасно)
<hr>
<pre>
cpuset="0";
</pre>
Привязать jail и&nbsp;его процессы к&nbsp;конкретным ядрам CPU. Значение&nbsp;0 (по-умолчанию) означает, что привязок к&nbsp;ядрам нет и&nbsp;процессы будут занимать все доступные ядра.
Значение отличное от&nbsp;нуля идентифицирует ядро или список ядер, на&nbsp;которых дозволено работать клетке. Запись должна соответствовать форме записи параметра -l cpu-list
у&nbsp;команды <a href="http://www.freebsd.org/cgi/man.cgi?query=cpuset&apropos=0&sektion=0&manpath=FreeBSD+9.2-RELEASE&arch=default&format=html"><b>cpuset(1)</b></a>, например:
<pre>
cpuset="1";
</pre>
означает, что процессы будут работать только на&nbsp;ядре 1.
<pre>
cpuset="0-3"
</pre>
означает, что процессы будут работать на&nbsp;ядрах 0,1,2,3
<pre>
cpuset="0,3"
</pre>
означает, что процессы будут работать на&nbsp;ядрах 0&nbsp;и&nbsp;3
<br>
Данный функционал полезен, например, для профилирования&nbsp;ПО, или если вы&nbsp;хотите ограничить клетку определенными ядрами (или давать каждой клетке по&nbsp;своему ядру).
<hr>
<pre>
setfib="0";
</pre>
Привязать jail и&nbsp;его процессы к&nbsp;отдельной таблице маршрутизации. Значение&nbsp;0 (по-умолчанию) означает, что привязок нет и&nbsp;будет использоваться стандартная таблица маршрутизации.
Для того, чтобы использовать <b>setfib</b>, в&nbsp;файле /boot/loader.conf вам необходимо установить лимиты таблиц через параметр <b>net.fibs</b>. Например, если вы&nbsp;хотите
использовать пять отдельных таблиц маршрутизации, в&nbsp;/boot/loader.conf вы&nbsp;должны иметь следующую запись:
<pre>
net.fibs="5"
</pre>
<hr>
<pre>
exec.consolelog="0";
</pre>
Регулирует протоколирование вывода jail(8) при старте и&nbsp;останове клетки. По-умолчанию, используется значение <b>0</b>.
<br>
Возможные значения:
<br><br>
<b>0</b>&nbsp;&mdash; выключить exec.consolelog. В&nbsp;этом случае, при jstart/jstop будет показываться весь вывод процедуры запуска и&nbsp;останова.
<br>
<b>1</b>&nbsp;&mdash; Включить протоколирование в&nbsp;файл <i>${workdir}/var/log/${jname}.log</i>, где $jname&nbsp;&mdash; соответствующее имя клетки. При этом, на&nbsp;терминале
этих сообщений не&nbsp;будет.
<br>
<b><i>/path/to/file</i></b>&nbsp;&mdash; Произвольное имя файла. Например при значении <b>/dev/null</b>, клетка не&nbsp;будет выводить записи и&nbsp;куда-либо протоколировать процесс.
</body>
</html>