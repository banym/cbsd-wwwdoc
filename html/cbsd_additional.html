<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
<HEAD>
<META http-equiv="content-type" content="text/html; charset=UTF-8">
<META name="Description" content="CBSD Store">
<META name="Keywords" content="CBSD, BSDStore">
<LINK rel="shortcut icon" href="favicon.ico">

<title>CBSD - FreeBSD jails management tools</title>
</HEAD>
<!--# include file="/html/cbsdmenu_ru.html" -->
<body>
<center><FONT face="verdana,arial,helvetica" size="+1">Что необходимо знать о cbsd</font></center>
<FONT face="verdana,arial,helvetica" size="-1">
<br><br>
<body>
<p>
<b>Cbsd</b> представляет из себя дополнительный уровень абстракции над 
<a href="http://www.freebsd.org/cgi/man.cgi?query=jail&apropos=0&sektion=0&manpath=FreeBSD+9.2-RELEASE&arch=default&format=html">Jail framework</a> 
и частью функционала FreeBSD.
</p>
Некоторый список этого функционала, задействованного в cbsd: <br>
<br>
<li>vnet (VIMAGE)
<li>zfs
<li>racct/rctl
<li>ipfw
<li>pf
<li>carp
<li>hastd
<li>auditd

<br><p>Многие эти подсистемы не имеют непосредственного отношения к jail, однако, позволяют cbsd (являющейся связующим звеном
между этими компонентами) предоставить администратору системы более расширенную и комплексную систему для решения задач.
<br><br>
Ниже дана информация, полезная для системного администратора и описывающая архитектуру cbsd более детально.
<br><br>
Во-первых, глава <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/jails.html">FreeBSD Jails</a>  обязательна для изучения, чтобы
понимать, что представляет из себя jail в обычном виде.
<br><br>
Во-вторых, полезно знать о иерархии файловой системы cbsd. Условимся в документации использовать следующие именования и значения:
<br>
<li><b>Нода</b> - физический сервер/единица ресурсов.
<li><b>Клетка</b> - Jail, изолированное окружение со своим набором ПО/сервисом. В них может быть как серверные компоненты (DNS, Apache/nginx, postfix) так и графические окружения.
<li><b>Облако</b> - Ферма/кластер, связанные между собой нодами, одноранговая полноправная сеть (каждая нода может делать задачи другой посредством cbsd)
<li><b>cbsd</b> - некая сущность, имеющая контроль над нодой(ами) и определенными подсистемами FreeBSD, способная предоставлять упрощенные и единые действия (API) над нодами, клетками и предоставляющая ACL и разграничение прав для клиентов cbsd
<li><b>$workdir</b> - рабочий каталог cbsd на нодах, инициализируется через cbsd initenv при первом запуске. Обычно <b>/usr/jails</b>.
<li><b>$jname</b> - Какое-то имя клетки, учавствующей в примере.
<br><br>
Самые важные данные находятся в каталоге <b>$workdir/jails-data/$jname</b>, поскольку это непосредственно корень файловой системы клетки с именем </b>$jname</b>, 
если клетка создана с флагом <b>baserw=1</b>, либо содержит те данные клетки, которые накладываются на стандартный <b>$workdir/basejail/$basename</b> в каталоге
<b>${workdir}/jails</b>
<br><br>
Учитывая, что base вы всегда можете получить через сборку исходных кодов или скачав с репозитория, то другими словами, 
чтобы мигрировать клетку cbsd на любой другой проект по управлению клетками или воспользоваться базовым функционалом FreeBSD jail, 
главное - это иметь консистентные данные в этом каталоге.
<i>Примечение:</i> если использовать тип клетки md, то в каталог $workdir/jails-data/$jname будет содержать имидж клетки.
<br><br>
Второе по значимости в иерархии каталогов cbsd могут выступать конфигурационные файлы для создания клетки, которые располагаются
в каталоге <b>$workdir/jails-rcconf</b>. По сути, каждый файл - это конфигурация одной клетки для "jail -c " утилиты, однако, имеющие дополнительные cbsd-related параметры.
Эти файлы можно редактировать в любом редакторе при остановленной клетке.
<br><br>
Остальные каталоги не являются критически важными для самих клеток. К примеру, каталог <b>$workdir/jails-system</b>
служит в качестве дополнительного места хранения служебной информации к клетками, например в нем могут быть
конфигураторы сервисов, а также, статистика по трафику и загруженности, описание к клетке и тд.
<br><br>
Служебная информация для нужд самой cbsd находится в каталоге $workdir/db. Например, информация о списке добавленных нодах, инвентаризация
как локальной ноды так и удаленных, база данных с настройками клеток и тд.
<br><br>
Важными в плане безопасности, является каталоги <b>${workdir}/.rssh</b> и <b>${workdir}/.ssh</b>, в котором находятся приватные RSA ключи от пользователя cbsd с удаленных нодах и с локальной соответственно.
Следите за тем, чтобы данные этих каталогов были недоступены для других пользователей системы. По-умолчанию, читать ключ может только системный пользователь cbsd.
<br><br>
<h3><ins>Краткая сводка по иерархии cbsd</ins><a href="#Иерархия-cbsd"></a></h3>
<br>
<table border=1>

<tr><td>${workdir}/.rssh/</td><td>Каталог для хранения приватных ключей удаленных нод. Файлы добавляются и удаляются через команду <b>cbsd node</b></td></tr>
<tr><td>${workdir}/.ssh</td><td>Здесь хранится приватный и публичный ключ непосредственно данной ноды. Формируется на этапе инициализации при команде cbsd initenv. 
Именно отсюда будут забирать публичный ключ удаленные хосты по команде cbsd node mode=add. Имя, заданное на этапе initenv в вопросе nodename должен совпадать с написанием 
имени в аргументе node= при команде cbsd node mode=add. Имя файла ключа является md5 суммой от этого имени.</td></tr>
<tr><td>${workdir}/basejail</td><td>Здесь хранятся готовые к использованию базы и ядра FreeBSD (результат cbsd buildworld/buildkernel, 
cbsd installworld/installkernel или cbsd repo action=get sources=base/kernel)</td></tr>
<tr><td>${workdir}/etc</td><td>Конфигурационные файлы, необходимые для работы cbsd</td></tr>
<tr><td>${workdir}/export</td><td>Каталог по-умолчанию, в который будет сохраняться экспортированная в файл клетка (при команде cbsd jexport jname=$jname, в этом каталоге появится файл $jname.img)</td></tr>
<tr><td>${workdir}/import</td><td>Каталог по-умолчанию, из которого будет импортирован jail (при cbsd jimport jname=$jname, будет развернута клета $jname)</td></tr>
<tr><td>${workdir}/jails</td><td>В данном каталоге находятся точка монтирования корня для jail-ов, использующих baserw=0.</td></tr>
<tr><td>${workdir}/jails-data</td><td>В этом каталоге лежат данные клетки. Именно этим местам необходим бекап для сохранности данных клетки.
Также, если клетка использует baserw=1, эти каталоги являются корнем клетки при ее старте</td></tr>
<tr><td>${workdir}/jails-fstab</td><td>fstab файл для клеток. Синтаксис обычный для FreeBSD за тем лишь исключением, что путь к точке монтирования пишется относительно корня jail 
(запись <b>/usr/ports /usr/ports nullfs rw 0 0</b> в файле fstab.$jname означает, что из мастер-ноды каталог /usr/ports будет примонтирован при запуске в ${workdir}/jails/$jname/usr/ports)</td></tr>
<tr><td>${workdir}/jails-rcconf</td><td>rc.conf файлы клеток. Данные параметры можно менять в удобном для вас редакторе, либо через команды 
cbsd jset $jname param=val (например cbsd jset jname=$jname ip="192.168.0.2/24"). Менять эти параметры следует при выключенной клетке. </td></tr>
<tr><td>${workdir}/jails-system</td><td>Этот каталог может содержать какие-то вспомогательные скрипты, относящиеся к клетке (например скрипты-wizard-ы для настройки, 
конфигураторы и пр) а также, сохраняется трафик клетки, если используется ipfw и ее описание. Данный каталог учавствует при jimport/jexport операциях и мигрировании клеток</td></tr>
<tr><td>${workdir}/var</td><td>Каталог который содержит различную системную информацию cbsd. Например, в ${workdir}/var/db находится инвентаризация локальных и удаленных нод если 
они были добавлены</td></tr>
</table>

</body>
</html>
