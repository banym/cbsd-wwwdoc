<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
<HEAD>
<META http-equiv="content-type" content="text/html; charset=UTF-8">
<META name="Description" content="CBSD Store">
<META name="Keywords" content="CBSD, BSDStore">
<LINK rel="shortcut icon" href="favicon.ico">

<title>CBSD - FreeBSD jails management tools</title>
</HEAD>
<!--# include file="/html/cbsdmenu_ru.html" -->
<body>
<center><FONT face="verdana,arial,helvetica" size="+1">Что необходимо знать о cbsd</font></center>
<FONT face="verdana,arial,helvetica" size="-1">
<br><br>
<body>
<!--# include file="/html/currentver.html" -->
<b>cbsd</b> представляет из себя дополнительный уровень абстракции над 
<a href="http://www.freebsd.org/cgi/man.cgi?query=jail&apropos=0&sektion=0&manpath=FreeBSD+9.2-RELEASE&arch=default&format=html">Jail framework</a> 
и частью функционала FreeBSD.
</p>
Некоторый список этого функционала, задействованного в cbsd: <br>
<br>
<li>vnet (VIMAGE)
<li>zfs
<li>racct/rctl
<li>ipfw
<li>pf
<li>carp
<li>hastd
<li>auditd

<br><p>Многие эти подсистемы не имеют непосредственного отношения к <b>jail</b>, однако, позволяют <b>cbsd</b> (являющейся связующим звеном
между этими компонентами) предоставить администратору системы более расширенную и комплексную систему для решения задач.
<br>
Если вы столкнулись с какой-либо проблемой (например не стартует или пропала клетка, не знаете где лежат данные клетки и настройки cbsd, возникает какая-то ошибка в конфигурации и тд), то
ниже дана информация, описывающая структуру cbsd более детально.
<br><br>
Во-первых, глава <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/jails.html">FreeBSD Jails</a>  обязательна для изучения, чтобы
понимать, что представляет из себя jail в обычном виде.
<br><br>
Во-вторых, полезно знать о иерархии файловой системы <b>cbsd</b>. Условимся в документации использовать следующие именования и значения:
<br><br>
<li><b>Нода</b> - физический сервер/единица ресурсов.
<li><b>Клетка</b> - Jail, изолированное окружение со своим набором ПО/сервисом. В них могут быть как серверные компоненты (DNS, Apache/nginx, postfix) так и графические окружения. Клетки делятся на два типа - сервисные и целостные.
<li><b>Облако</b> - Ферма/кластер, связанные между собой нодами, одноранговая полноправная сеть (каждая нода может делать задачи другой посредством <b>cbsd</b>)
<li><b>База</b> - в контексте cbsd - копия базовой системы FreeBSD.
<li><b>cbsd</b> - некая сущность, имеющая контроль над нодой(ами) и определенными подсистемами FreeBSD, способная предоставлять упрощенные и единые действия (API) над нодами, клетками и предоставляющая ACL и разграничение прав для клиентов cbsd
<li><b>$workdir</b> - рабочий каталог cbsd на нодах, инициализируется через cbsd initenv при первом запуске. Обычно <b>/usr/jails</b>.
<li><b>$jname</b> - Какое-то имя клетки, учавствующей в примере.
<br><br>
Вся рабочие данные <b>cbsd</b> находится в каталоге <b>$workdir</b> (например <i>/usr/jails</i>), он же является домашним каталогом для пользователя <b>cbsd</b> и вы всегда
можете быстро перейти в него по команде:
<pre>
   % cd ~cbsd
</pre>
Самые важные данные находятся в каталоге <b>$workdir/jails-data/$jname</b>, поскольку это непосредственно корень файловой системы клетки с именем </b>$jname</b>, 
если клетка создана с флагом <b>baserw=1</b>, либо содержит те данные клетки, которые накладываются на стандартный <b>$workdir/basejail/$basename</b> в каталоге
<b>${workdir}/jails</b>
<br><br>
Учитывая, что базу вы всегда можете получить через сборку исходных кодов или скачав с репозитория, то для миграции cbsd jail на любой другой проект по управлению клетками самое
главное - это иметь консистентные данные в этом каталоге.
<i>Примечение:</i> если использовать тип клетки md, то в каталог $workdir/jails-data/$jname будет содержать имидж клетки.
<i>Примечание2:</i>Если вы используете ZFS и обнаружили, кто данные каталоги пусты (при остановленной клетке), проверьте вывод команды:
<pre>    % zfs list
</pre>
cbsd может размонтировать данные когда клетка неактивна. Для доступа к данным выполните:
<pre>
   % zfs mount соответствующая_$jname_файловая_система
</pre>
Второе по значимости в иерархии каталогов cbsd могут выступать конфигурационные файлы для создания клетки, которые располагаются
в каталоге <b>$workdir/var/db/</b>. 
Все параметры клетки сохраняются в SQLite3 файле, на который указывает симлинк ${workdir}/var/db/local.sqlite в таблице jails. Схема таблицы описана в файле <i>${workdir}/share/local-jails.schema</i>
Например, для того чтобы посмотреть все клетки на ноде и их ip адреса:
<pre>
   % sqlite3 /usr/jails/var/db/local.sqlite "select jname,ip4_addr from jails"
</pre>
Когда клетка запускается, cbsd генерирует jail.conf файл из данных SQLite3 командой 
<pre>
   % cbsd jmkrcconf jname=jailname
</pre>
Вы можете использовать эту команду, если хотите перейти с <b>cbsd</b> обратно на базовый вариант (потеряв функционал <b>cbsd</b>)
<br>
Каталог <b>$workdir/jails-system/</b> служит в качестве дополнительного места хранения служебной информации к клеткам, например в нем могут быть
конфигураторы сервисов, файл с описанием клетки, статистика по трафику и потребляемым ресурсам и тд.
<br>
Служебная информация для нужд самой cbsd находится в каталоге $workdir/db. Например, информация о списке добавленных нодах, инвентаризация
как локальной ноды так и удаленных и тд.
<br>
Важными в плане безопасности, является каталоги <b>${workdir}/.rssh</b> и <b>${workdir}/.ssh</b>, в котором находятся приватные RSA ключи от пользователя cbsd с удаленных нодах и с локальной соответственно.
Следите за тем, чтобы данные этих каталогов были недоступены для других пользователей системы. По-умолчанию, читать ключ может только системный пользователь cbsd.
<br><br>
И наконец в-третьих, обязательно ознакомьтесь с модификациями, которые готовит cbsd в вашей конфигурации: <a href="custom_freecbsd.html">Модификации, которые выполняют скрипты cbsd в FreeBSD</a>
<br>
<h3><ins>Краткая сводка по иерархии cbsd</ins><a href="#Иерархия-cbsd"></a></h3>
<br>
<table border=1>
<tr><td>${workdir}/.rssh/</td><td>Каталог для хранения приватных ключей удаленных нод. Файлы добавляются и удаляются через команду <b>cbsd node</b></td></tr>
<tr><td>${workdir}/.ssh</td><td>Здесь хранится приватный и публичный ключ непосредственно данной ноды. Формируется на этапе инициализации при команде cbsd initenv. 
Именно отсюда будут забирать публичный ключ удаленные хосты по команде cbsd node mode=add. Имя, заданное на этапе initenv в вопросе nodename должен совпадать с написанием 
имени в аргументе node= при команде cbsd node mode=add. Имя файла ключа является md5 суммой от этого имени.</td></tr>
<tr><td>${workdir}/basejail</td><td>Здесь хранятся готовые к использованию базы и ядра FreeBSD (результат cbsd buildworld/buildkernel, 
cbsd installworld/installkernel или cbsd repo action=get sources=base/kernel)</td></tr>
<tr><td>${workdir}/etc</td><td>Конфигурационные файлы, необходимые для работы cbsd</td></tr>
<tr><td>${workdir}/export</td><td>Каталог по-умолчанию, в который будет сохраняться экспортированная в файл клетка (при команде cbsd jexport jname=$jname, в этом каталоге появится файл $jname.img)</td></tr>
<tr><td>${workdir}/import</td><td>Каталог по-умолчанию, из которого будет импортирован jail (при cbsd jimport jname=$jname, будет развернута клета $jname)</td></tr>
<tr><td>${workdir}/jails</td><td>В данном каталоге находятся точка монтирования корня для jail-ов, использующих baserw=0.</td></tr>
<tr><td>${workdir}/jails-data</td><td>В этом каталоге лежат данные клетки. Именно этим местам необходим бекап для сохранности данных клетки.
Также, если клетка использует baserw=1, эти каталоги являются корнем клетки при ее старте</td></tr>
<tr><td>${workdir}/jails-fstab</td><td>fstab файл для клеток. Синтаксис обычный для FreeBSD за тем лишь исключением, что путь к точке монтирования пишется относительно корня jail 
(запись <b>/usr/ports /usr/ports nullfs rw 0 0</b> в файле fstab.$jname означает, что из мастер-ноды каталог /usr/ports будет примонтирован при запуске в ${workdir}/jails/$jname/usr/ports)</td></tr>
<tr><td>${workdir}/jails-system</td><td>Этот каталог может содержать какие-то вспомогательные скрипты, относящиеся к клетке (например скрипты-wizard-ы для настройки, 
конфигураторы и пр) а также, сохраняется трафик клетки, если используется ipfw и ее описание. Данный каталог учавствует при jimport/jexport операциях и мигрировании клеток</td></tr>
<tr><td>${workdir}/var</td><td>Каталог который содержит различную системную информацию cbsd. Например, в ${workdir}/var/db находится инвентаризация локальных и удаленных нод если 
они были добавлены</td></tr>
<tr><td>/usr/local/cbsd</td><td>Копия оригинальных файлов cbsd устанавливаемая портом. Также, содержит рабочие скрипты в каталоге <b>sudoexec</b></td></tr>
</table>
<h3><ins>Подсчет трафика jail</ins><a href="#Иерархия-cbsd"></a></h3>
В данный момент, для подсчета трафика jail используются правила <b>count</b> у фильтра <b>ipfw</b>. 
<b>cbsd</b> назначает для счетчиков номера правил из диапазона <b>99 - 2000</b> (можно изменить в cbsd.conf).
<br>Поэтому будьте внимательны и следите за тем, чтобы ваши правила IPFW следовали после указанного диапазона.
<br>
<h3><ins>Если что-то пошло не так</ins></h3>
<br>
<li> В случае, если при выполнении утилит <b>cbsd</b> возникают ошибки, рекомендуется оформить проблему в баг-трекере проекта: <a href="https://github.com/olevole/cbsd/issues">cbsd issues</a> или сообщить об ошибке по email: <b>cbsd</b> <i>at</i> <b>bsdstore.ru</b>
<br><br>
<li> Делайте резервные копии каталогов ${workdir}/var/db, ${workdir}/var/db, ${workdir}/jails-fstab, ${workdir}/jails-system и, конечно же, данные клеток в каталоге ${workdir}/jails-data
<br><br>Если вы будете восстанавливать Jail из бекапа, вам потребуется файл ${workdir}/jails-system/${jname}/rc.conf_${jname} - после того как каталоги jails-data и jails-fstab клетки вы вернете обратно в структуру $workdir каталогов,
скопируйте данный rc.conf_${jname} в каталог ${workdir}/jails-rcconf/ - после этого, по команде
<pre>
   % cbsd jls
</pre>
      
Jail будет выводится в списке в статусе Unregister. По команде 
<pre>
% cbsd jregister jname=$jname
</pre>

вы вернете клетку в общий пул и рабочее состояние.


</body>
</html>
