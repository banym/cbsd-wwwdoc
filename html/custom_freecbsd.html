<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
<HEAD>
<META http-equiv="content-type" content="text/html; charset=UTF-8">
<META name="Description" content="CBSD Store">
<META name="Keywords" content="FreeBSD VIMAGE jals, FreeBSD VNET jails">
<LINK rel="shortcut icon" href="favicon.ico">

<title>CBSD - FreeBSD jails management tools</title>
</HEAD>
<!--# include file="/html/cbsdmenu_ru.html" -->
<body>
<!--# include file="/html/currentver.html" -->
<br>
<center><FONT face="verdana,arial,helvetica" size="+1">Модификации, которые выполняют скрипты cbsd в FreeBSD</font></center>
<FONT face="verdana,arial,helvetica" size="-1">
<br><br>
<body>
В связи с тем что курс, взятый CBSD ориентирован на связь большого количества функционала для предоставлении комплексного решения, система
для своей работы делает или предлагает сделать ряд специфичных настроек. Для чего и где эти изменения нужны, описывает данная страница, 
что также важно для полной деинсталляции cbsd ;-)

<br><br>
<center><h3>файл <b>/etc/rc.conf</b></h3></center>
Следующие параметры в /etc/rc.conf затрагивает <b>cbsd</b> для корректной работы.
<br><br>
1) <i>rcshutdown_timeout</i><br>
<br>
Данный параметр регулирует время отработки последовательность завершения работы из rc.shutdown файлов - если по истечению этого времени 
останавливаемый процесс не передал управление, система убьет его. Для серверов, имеющих большое количество клеток, в которых в свою очередь, 
могут работать длительные по остановке и чувствительные к убийству сервисы (например базы данных), значение по-умолчанию (120) крайне мало.
В связи с этим, <b>cbsd</b> изменяет его при первой инициализации.
<br><br>
Если вы хотите оставить значение по-умолчанию и пресечь переназначение параметра при <b>cbsd initenv</b>, просто продублируйте значение параметра
из /etc/defaults/rc.conf: <b>cbsd</b> не будет менять параметр, если в /etc/rc.conf он уже присутствует:
<pre>
% grep rcshutdown_timeout /etc/defaults/rc.conf >> /etc/rc.conf
</pre>
2) <i>sshd_flags и порт SSHd в мастер-хосте по-умолчанию</i>
<br><br>
Также как в случае с <b>rcshutdown_timeout</b> в <i>/etc/rc.conf</i>, при отстутствии в <i>/etc/rc.conf</i> параметра <b>sshd_flags</b>,
cbsd initenv предложит вам изменить порт (22) по-умолчанию для демона <b>sshd</b> на 22222 порт, выполнив это через установку записи:

<pre>
  sshd_flags="-p22222"
</pre>
Будьте крайне внимательны к этому изменению. Если вы хотите оставить стандартные флаги sshd демона, продублируйте запись для sshd_flags из
файла /etc/defaults/rc.conf в /etc/rc.conf и cbsd не будет предлагать изменение.
<br>
Также, возможно вы захотите запретить ресолв хоста по имени DNS, что может существенно ускорять соединения между нодами, расширив запись в /etc/rc.conf до
<pre>
  sshd_flags="-oUseDNS=no -p22222"
</pre>
<br>
Порт 22222 вместо стандартного 22 предлагается к изменению по некоторым следующим соображениям:
<br><br>
<li> до этого порта доходит меньше сканеров sshd для bruteforce. Конечно же, этот аргумент несерьезен ;-) и если вы хотите защитится от перебора, присмотритесь к утилитам <b>security/{bruteblock,denyhosts}</b>;
<li> Идеология работы <b>cbsd</b> с нодами подразумевает связь серверов между собой через ssh и желательно, чтобы уникальный/выбранный порт sshd (в данном случае 22222), всегда идентифицировал <b>sshd</b> обслуживающим <ins><b>ноду</b></ins>.
На практике, разные порты sshd на мастер-ноде и клеток полезны тем, что если вы внезапно забыли на какой именно ноде работает ваша клетка <b>jail1024.my.domain</b>, вы всегда можете быть уверенными что соединяясь на хост <b>jail1024.my.domain</b> по
22222 порту вы непременно попадете на физическую ноду, обслуживающую эту клетку. Второй момент - это клетки с параметром oninterface=0 и имеющие одинаковый с основной системой IP. 
<br>
<br>Кроме этого, подобная настройка исключит конфликты портов sshd между нодой и sshd сервисом в клетках.
<br><br>
Также учитывайте, что при параметре <b>applytpl=1</b> и создании новой клетки, <b>cbsd</b> таким же способом конфигурирует порт клетки на порт 2222 (однако, sshd_enable по-умолчанию остается в NO).
Данное изменение также продиктовано желанием идентифицировать jail уникальным номером порта. Что, в свою очередь, удобно использовать для систем управления конфигурациями, как например 
<a href="http://www.ansibleworks.com/"><b>Ansible</b></a>, внося имена клеток в отдельный домен (например jail1024.<b>j</b>.my.domain) и по маске из <b>.j.</b> в зоне система будет применять определенные фильтры и знать корректный порт для 
установления соединения. Подобный пример из <b>cbsd</b> и <b>Ansible</b> будет описан отдельной статьей.
<br>
Для того, чтобы не править скрипты на серверах, откуда происходит соединение с нодой или клетками, рекомендуется использовать возможности ~/.ssh/config , в котором можно указать порты для конкретного хоста или маске хостов, например:
<pre>
  # this server on 22 default ssh port
  Host otherserver.my.domain
  Port 22
  User root

  # mask for jails which have records in blabla.j.my.domain zones:
  Host *.j.*
  Port 2222

  # Default records - all host on 22222 port
  Host *
  ControlMaster auto
  ControlPath ~/.ssh/sockets/%r@%h:%p
  Port 22222
  StrictHostKeyChecking no
  UserKnownHostsFile /dev/null
<br>
<center><h3>файл <b>/var/cron/tabs/root</b>, /etc/periodic.conf и cbsd periodic</h3></center>
<br>
<b>cbsd</b> может иметь "внутренние" задачи, требующие периодического выполнения (например снятие трафика, <b>RACCT</b> статистики). Для этого, она может сконфигурировать свой periodic через запись вида:
<pre>
* * * * * /usr/bin/lockf -s -t0 $workdir/ftmp/periodic_minutes /usr/sbin/periodic minutes > /dev/null 2>&1
0 * * * * /usr/bin/lockf -s -t0 $workdir/ftmp/periodic_hourly /usr/sbin/periodic hourly > /dev/null 2>&1
</pre>
в пользовательский cron tab для пользователя <b>root</b> (/var/cron/tabs/root). Пользовательский cron tab, вместо системного, используется по соображениям, описанными в <a href="html/articles/upgrade_for_fun.html">Не бойтесь mergemaster</a>.
Если вы не хотите чтобы подобны вызовы тревожили вашу систему, вызовите редактор cron tab через команду:
<pre>
% crontab -e
</pre>
и поставьте эти строчки с символами комментария '#', символ комментария:
<pre>
#* * * * * /usr/bin/lockf -s -t0 $workdir/ftmp/periodic_minutes /usr/sbin/periodic minutes > /dev/null 2>&1
#0 * * * * /usr/bin/lockf -s -t0 $workdir/ftmp/periodic_hourly /usr/sbin/periodic hourly > /dev/null 2>&1
</pre>
. В этом случае, <b>cbsd initenv</b> не будет вносить изменения.
<br>
<center><h3>файл <b>/boot/loader.conf</b>, модули ядра, net.inet.ip.fw.default_to_accept</h3></center>
<br>
В том случае, если вы используете <b>cbsd natcfg, cbsd naton</b> или отвечаете утвердительно на вопрос использования NAT во время
<b>cbsd initenv</b>, система может оставлять (с согласия пользователя) в <b>/boot/loader.conf</b> следующие записи:
<pre>
pf_load=YES
ipfw_load=YES
ipfw_nat_load=YES
libalias_load=YES
net.inet.ip.fw.default_to_accept=1
</pre>
в зависимости от того, какой NAT используется. Сами правила NAT прописываются в структуре каталогов <b>cbsd</b>.
Параметр 
<pre>
net.inet.ip.fw.default_to_accept=1
</pre>
роли в работе cbsd не играет, однако он включен по причинам того, что модуль IPFW по-умолчанию запрещает все, а на момент настройки <b>cbsd</b> часть
пользователей могут не настроить ipfw правила (или настроят с ошибкой), что повлечет за собой потерю доступа к системе. Имейте ввиду, что данный
параметр заставляет последнее правило <b>65535</b> выглядеть следующим образом:
<pre>
allow ip from any to any
</pre>
Подробнее: <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/firewalls-ipfw.html">FreeBSD handbook::Firewalls-ipfw</a>
<br><br>
Кроме этого, при старте NAT (<b>cbsd naton</b>), выполняется вызов:
<pre>
% sysctl -qn net.inet.ip.forwarding=1
% sysctl -qn net.inet6.ip6.forwarding=1
</pre>
для корректного функционирования NAT, а при запуске <b>vnet</b>-клетки ( VIMAGE ), автоматически подгружается модуль <b>if_bridge</b>.
<br><br>
Обратите внимание, что <b>cbsd</b> не удаляет за собой записи в /boot/loader.conf при ее удалении, или к примеру, если вы переходите от
одного NAT фреймворка к другому (к примеру сначала сконфигурировани PF, затем переключили на IPFW), то при выборе другого фреймворка,
модули предыдущего удаляться не будут. 
<br>
<center><h3>файл <b>/usr/local/etc/sudoers.d/cbsd_sudoers</b></h3></center>
Большая часть команд <b>cbsd</b> требует полномочий привилегированного пользователя, в связи с чем испольуется утилита <b>sudo</b> и конфигурационный
файл /usr/local/etc/sudoers.d/cbsd_sudoers следующего содержания:
<pre>
Defaults     env_keep += "workdir DIALOG NOCOLOR"
Cmnd_Alias   CBSD_CMD = /usr/jails/sudoexec/*,/usr/local/cbsd/sudoexec/*
cbsd   ALL=(ALL) NOPASSWD: CBSD_CMD
</pre>
Данные записи позволяют запускать скрипты с полномочиями пользователя root в следующих каталогах:
<pre>
/usr/jails/sudoexec/
/usr/local/cbsd/sudoexec/
</pre>
и без необходимости вводить пароль <b>root</b>
