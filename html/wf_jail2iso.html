<b>Команды</b>:<br>
<pre>
% cbsd jail2iso
</pre>
<b>Описание</b>:
<br><br>
Скрипт <b>jail2iso</b> позволяет создать загрузочный образ для CD/DVD/Memstick из указанной клетки.
Несмотря на то, что функционал <b>jail2iso</b> не используется в работы <b>cbsd</b> или клеток, этот
скрипт может быть очень полезен для легкого и комфортного построения кастомизированных LiveCD, содержимое
которых вы можете устанавливать, настраивать и проверять в клетке. Например, этот функционал удобен для:
<br><br>
<li> Создание Rescue-систем с необходимыми инструментами на борту
<li> Построение собственного дистрибутива FreeBSD
<li> Создание образов для бездисковых серверов/станций (например загружаемые с PXE, MicroSD, Flash, CD/DVD, и тд) и монтирующие домашние
каталоги или клетки/файлы с данными по NFS/FibreChannel/iSCSI/InfiniBand.
<br><br>
Схема работы скрипта:
<br><br>
<li> Создание файловой иерархии будущего образа, состоящей из подмонтированной базы и данных клетки
<li> Создание MFS/UZIP образа, который будет оставаться в памяти. Используется в основном для ускорения работы в режиме LiveCD, позволяя "закешировать" часто вызывающиеся утилиты и библиотеки, например
от / до /usr.
<li> Монтирование поверх MFS иерархии данных с файловой системы носителя через nullfs/RO
<li> Монтирование tmpfs поверх RO файловой системы для возможности производить модификации.
<br>
<br>
Если вам необходимо ряд директорий при загрузке образа перезагрузить в RW через tmpfs, до вызова утилиты <b>jail2iso</b> необходимо прописать в файл <i>$systemdir/jail/tmpfsdir</i> все пути.
<br>Например для <b>rescuebsd</b> клетки это файл: <i>/usr/jails/jails-system/rescuebsd/tmpfsdir</i> содержащий:
<br>
<pre>
/root
/var/run
/var/cache
/var/db
/var/spool
/var/log
/usr/home
/usr/local/etc
</pre>
<br>
Данные записи будут обработаны <i>/etc/rc.d/tmpfsdir</i>, который сохранит на образ <b>jail2iso</b>. Все содержимое в этих файлах, которое находится на jail, будет перемещено на tmpfs файловую систему.
<br>Поскольку RW области монтируются через TMPFS, количество доступной для записи памяти будет зависеть от количества оперативной памяти, на котором запускается LiveCD.
<br><br>
Вы можете предпочесть написать собственный /boot/loader.conf на создаваемом образе. Для этого, сохранив файл <b>loader.conf</b> в каталог <i>$systemdir/$jname/</i>. Все, что вы напишете в этом файле, добавиться к файлу loader.conf,
генерируемого <b>jail2iso</b>, которая имеет следующие обязательные записи:
<pre>
geom_uzip_load="YES"
tmpfs_load="YES"
nullfs_load="YES"

mfs_load="YES"
mfs_type="mfs_root"
mfs_name="/mfsroot"
vfs.root.mountfrom="ufs:/dev/md0"

net.inet.ip.fw.default_to_accept=1
</pre>
Например, для клетки <b>xrescuebsd</b>, которая загружается в режиме KMS на ядре с newcons, имеется файл  <i>/usr/jails/jails-system/xrescuebsd/loader.conf</i> со следующим содержимым:
<pre>
kern.ipc.shmmni=4096
kern.ipc.shmseg=4096
radeonkms_load="YES"
i915kms_load="YES"
linux_load="YES"
</pre>
<br>
Вы можете указать, какой тип образа <b>jail2iso</b> должна создать, ISO образ с cd9960 для CD/DVD/Виртуальных машин или Memstick, образ, который вы сможете записать на USB Flash носитель.
<br>
<b>cbsd jail2iso</b> не контроллирует и не лимитирует объемы конечного результата - они ограничены лишь вашим носителем, для которого создается образ.
Для создания ISO образа:
<pre>
cbsd jail2iso media=iso ..
</pre>
Для создания memstick:
<pre>
% cbsd jail2iso media=memstick ..
</pre>
<br>
Каталог, куда будет сохранен образ указывается через аргумент <b>destdir</b>.
<br><br>
По-умолчанию, на образ будет сохранено GENERIC ядро из каталога $workdir/basejail/. Его можно получить по команде:
<pre>
cbsd repo action=get sources=kernel
</pre>
для вашей версии FreeBSD, или собрать самостоятельно через <b>cbsd buildkernel</b>.
Если ядро GENERIC не подходит, через аргумент <b>name</b> для <b>jail2iso</b> вы можете указать другое ядро, если оно у вас есть.
<br><br>
Кроме этого, для уменьшения размера финального образа, jail2iso выполняет ряд действий:
<br><br>
<li> удаление .a-архивных файлов в каталогах библиотек
<li> удаление необязательных данных по файлу-списку.
<br><br>По-умолчанию, данный список расположен в $workdir/share/jail2iso-prunelist.
Вы можете его откорректировать по собственному усмотрению или создать свой, указав путь к нему через аргумент <b>prunelist</b>

<br><br>
Пример создания memstick из клетки jail1:
<br><pre>
% cbsd jail2iso media=memstic jname=jail destdir=/tmp
</pre>
Если файл /tmp/jail1.img создался, его можно записать на USB носитель через команду:
<pre>
dd if=/tmp/mc.img of=/dev/da0 bs="10240" conv="sync"
</pre>
, если <b>/dev/da0</b> - это USB flash носитель.
<br><br><center>
