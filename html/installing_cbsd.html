<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
<HEAD>
<META http-equiv="content-type" content="text/html; charset=UTF-8">
<META name="Description" content="CBSD Store">
<META name="Keywords" content="CBSD, BSDStore">
<LINK rel="shortcut icon" href="favicon.ico">

<title>CBSD - FreeBSD jails management tools</title>
</HEAD>
<!--# include file="/html/cbsdmenu_ru.html" -->
<body>
<center><FONT face="verdana,arial,helvetica" size="+1">Установка cbsd</font></center>
<FONT face="verdana,arial,helvetica" size="-1">
<br><br>
<body>
<h3><ins>Требования</ins><a href="#требования"></a></h3>
Поскольку <b>cbsd</b> - это лишь ряд упрощающих работу с клетками скриптов, вам подойдет любое оборудование, на котором запустится FreeBSD.
Предполагается, что cbsd устанавливается на абсолютно чистую и свежеустановленную FreeBSD, поскольку настройки ряда конфигурационных
файлов <a href="custom_freecbsd.html">будут изменены</a>.
Для полноценной работы, желательно иметь:<br><br>
<li> версию FreeBSD не ниже 9.1-RELEASE.
<li> архитектуру <b>amd64</b>, ввиду того, что разработка ведется под нее.
<li> файловую систему ZFS, ввиду использования предлагаемых ZFS ряда возможностей.
<li> ядро с поддержкой RACCT/RCTL и VIMAGE (<b>cbsd</b> может выкачать нужное ядро из своего репозитория с вашего согласия)
<br>
<h3><ins>Версионность cbsd</ins><a href="#версионность-cbsd"></a></h3>
Первые две цифры версии cbsd кореллирует с версиями FreeBSD, для которых она разрабатывалась и тестировалась.
Версия 9.2.0 означает, что скрипты писались для FreeBSD 9.2. Третья цифра означает версию cbsd.

<h3><ins>Установка cbsd и подготовка к работе</ins><a href="#Установка-cbsd"></a></h3>
1)<br>
<p>a) cbsd можно установить через дерево портов FreeBSD:</p>
<b>
<pre>
    % make -C /usr/ports/sysutils/cbsd install
</pre>
</b>
или из репозитория:
<b>
<pre>
    % pkg install cbsd
</pre>
</b>
либо <br>
<p>b) предварительно установив необходимые зависимости: <b>libssh2, sudo, rsync, sqlite3</b></p>
<b>
<pre>
    % make -C /usr/ports/security/sudo install
    % make -C /usr/ports/security/libssh2 install
    % make -C /usr/ports/net/rsync install
    % make -C /usr/ports/databases/sqlite3 install
    % make -C /usr/ports/devel/git install
</pre>
</b>
получить последнюю версию cbsd из github:
<pre>
% git clone https://github.com/olevole/cbsd.git /usr/local/cbsd
</pre>
2)<br>
<p>В классической инсталляции, cbsd содержится в двух копиях. Одна из них (<i>/usr/local/cbsd</i>), содержит дистрибутив, исходный код и конфигурационные файлы по-умолчанию.
Также, эта копия может использоваться для управления клетками в случае, если основная копия повреждена (например некорректно обновилась и тд). 
Указатель того, с каким каталогом скриптов работать, является переменная окружения <i>workdir</i>.</p>
<p>Для инициализации рабочей (основной) копии cbsd, служит команда <strong>initenv</strong>, с запуском которой в первом вызове необходимо указать через переменную окружения
 <i>workdir</i> расположение рабочего каталога, а также ответить на ряд вопросов. </p>
3) Инициализация с рабочим каталогом в <i>/usr/jails</i>:</p>
<b>
<pre>
% env workdir="/usr/jails" /usr/local/cbsd/sudoexec/initenv
</pre>
</b>
При первом запуске проследует диалог вопрос-ответ по основным настройкам ноды. Ожидаемые примеры ввода система пишет в качестве примера (e.g.), нажатие Enter
без заполнения ввода приведет к использованию значения, предложенного в качестве примера.
После каждого обновления cbsd, initenv необходимо вызывать вновь.
Последующие разы initenv можно запускать через cbsd (настройка рабочего каталога сохраняется в <b>/etc/rc.conf</b>).
<p>При первичной инициализации могут встретиться следующие вопросы:</p>
<li><strong>Please fill nodename</strong> - Имя ноды. Если будет работа с несколькими нодами, это имя должно быть уникальным.
Рекомендуется использовать имя, аналогичное hostname. Именно это имя используется при работе с данным серверов через удаленных хосты. Пример: node1.my.domain.
<li><strong>Please fill nodeip</strong> - Рабочий и постоянный IP ноды. Он не должен быть alias-ом и желательно прописывать данный IP на отдельно скоммунтированный
(свободный от любого другого кроме management-трафика) интерфейс. Например: 192.168.1.2
<li><strong>Please fill nodeloc</strong> - Информативная строчка. Будет использоваться в будущем в WEB интерфейсе. Здесь можно оставить информацию о географической расположенности этой ноды. Например: USA, Dallas DC.
<li><strong>Please fill jnameserver</strong> - Список DNS сервер, устанавливаемых в <i>/etc/resolv.conf</i> созданных клеток. Если их несколько - прописывать через запятую.
Рекомендуется поднимать на master-ноде локальный named для кеширования запросов. Для того, чтобы клетки могли его использовать, необходимо в <i>/etc/namedb/named.conf</i> поменять строчку
<pre>
listen-on       { 127.0.0.1; };
</pre>
на
<pre>
listen-on       { any; };
</pre>
и, если IP адрес ноды 192.168.1.2, указать в этом поле: 192.168.1.2,8.8.8.8 (прописав первичным DNS - локальный, вторым - публичный DNS от Google).
Для автоматического запуска named, в <i>/etc/rc.conf</i> необходимо вписать
<pre>
named_enable="YES"
</pre>
Для запуска named без перезагрузки, выполнить команду
 <b>
<pre>
service named start
</pre>
</b>
<li><strong>Please fill nodeippool</strong> - Список подсетей, в которых дозволено запускаться клеткам. Если сетей несколько - используется пробел в качестве разделителя. Например: 10.0.0.0/24 192.168.1.128/29
<li><strong>Please fill natip</strong> - Здесь необходимо ввести IP адрес, который будет выступать в качестве NAT для приватных адресов. Обычно это IP вашей ноды. Например: 192.168.1.2 
<li><strong>Please fill fbsdrepo</strong> - Использовать ли официальный репозиторий FreeBSD для получения base. Ожидается ответ 1 или 2. Если на серверах FreeBSD базы не обнаружено - используется репозиторий cbsd. 
Например: 1.
<li><strong>Please fill zfsfeat</strong> - Использовать ли возможности файловой системы ZFS (клоны, снапшоты). Ожидается ответ 1 или 2. Вопроса не будет, если система запущена не на ZFS.
<li><strong>Please fill mdtmp</strong> - Создать ли memory-disk, через который система будет проводить временные операции над файлами (локи, временные копии). По-умолчанию, диск равняется 8MB.
<li><strong>Configure NAT for RFC1918 Network?</strong> - Использовать ли трансляцию приватных адресов? Если клетки создаются в RFC1918 сетях, необходимо включить. Например: 1.
<li><strong>Which one NAT framework should be use: [pf or ipfw]</strong> - Какой инструмент для NAT предпочесть. Рекомендуемый - pf. Например: 1
<br><br>
<b>Внимание:</b> все настройки сохраняются в файле <b>$workdir/nc.inventory</b> и могут быть изменены в любом доступном редакторе. Если вы хотите инициировать диалог с первичными настройки вновь, достаточно удалить этот файл.
<br>
<p style="color:RED">Внимание! В процессе первой установки, создается системный пользователь с именем <b>cbsd</b> и доступом в шелл, через который удаленные cbsd ноды будут взаимодействовать через ssh. Пожалуйста,
отнеситесь к выбору сложности пароля с максимальным вниманием. В дальнейшем, пароль можно изменить через стандартную команду <b>passwd cbsd</b></p>
</body>
</html>
