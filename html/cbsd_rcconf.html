<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
<HEAD>
<META http-equiv="content-type" content="text/html; charset=UTF-8">
<META name="Description" content="CBSD Store">
<META name="Keywords" content="CBSD, BSDStore">
<LINK rel="shortcut icon" href="favicon.ico">

<title>CBSD - FreeBSD jails management tools</title>
</HEAD>
<!--# include file="/html/cbsdmenu_ru.html" -->
<body>
<!--# include file="/html/currentver.html" -->
<center><FONT face="verdana,arial,helvetica" size="+1">параметры клеток cbsd</font></center>
<FONT face="verdana,arial,helvetica" size="-1">
<br><br>
<body>
<p>Каждая клетка cbsd имеет свой набор настроек, который используется при старте, останове и работе клеток.
Здесь дана краткая информация стандартных параметров.
<hr>
<pre>
jname="jail1";
</pre>
Непосредственно, уникальное имя клетки. Это то имя, которое видно по команде <b>cbsd jls</b> или в списке инвентаризации нод.
Данное поле нельзя менять вручную. Если вы хотите поменять имя клетки, воспользуйтесь командой <b>cbsd jrename</b>, поскольку имя клетки
используется во многих настройках и путях на файловой системе.
<hr>
<pre>
path="/usr/jails/jails/jail1";
</pre>
Указывает на путь, который будет использован в качестве корня при старте клетки. Вышеописанная конфигурация характерна для клеток,
которые имеют настройку baserw равную 0, тоесть, база которых смонтирована в только-чтение.
<br>В этом случае, алгоритм работы jstart будет следующим:
<br>
<br>1) смонтировать через nullfs базу определенной версии (см. ниже) в каталог /usr/jails/jails/$jname
<br>2) на уже смонтированную базу $workdir/jails/jails/$jname подмонтировать каталоги, относящиеся непосредственно к клетке (из каталога $workdir/jails-data/$jname), обычно уже в режиме записи.
<br>3) стартовать клетку с корнем $workdir/jails/jails/$jname
<br>
<br>Если же baserw=1, то nullfs не исползуется, и клетка сразу стартует с каталогом $workdir/jails-data/$jname  в качестве корня. В этих случаях, параметр path обычно выглядит как
<br>
<br>path="/usr/jails/jails-data/jail1-data";
<hr>
<pre>
host_hostname="jail1.my.domain";
</pre>
FQDN, полное имя клетки. Данное поле нельзя менять вручную. Если вы хотите поменять имя клетки, воспользуйтесь командой <b>cbsd jrename</b>
<hr>
<pre>
ip4_addr="10.0.0.5/24";
</pre>
IP адрес клетки. Если планируется использовать несколько IP адресов, они записываются через запятую:
<br>
<br>ip4_addr="10.0.0.5/24,192.168.0.2/30,54:04:a6:b2:11:c4/64";
<hr>
<pre>
mount_devfs="1";
</pre>
Смонтировать ли в клетку файловую систему devfs (каталог /dev). Как правило, большинство сервисов без этого просто не смогут работать.
<hr>
<pre>
allow_mount="1";
</pre>
Можно ли пользователям или сервисам, находящимся внутри клетки монтировать другие файловые системы.
<hr>
<pre>
allow_devfs="0";
</pre>
Можно ли пользователям или сервисам, находящимся внутри клетки монтировать devfs
<hr>
<pre>
allow_nullfs="0";
</pre>
Можно ли пользователям или сервисам, находящимся внутри клетки монтировать nullfs
<hr>
<pre>
mount_fstab="/usr/jails/jails-fstab/fstab.jail1";
</pre>
Путь к файлу, содержащему список каталогов или файловых систем, которые будут примонтированы в клетку при ее запуске
<hr>
<pre>
arch="amd64";
</pre>
Архитектура клетки (и соответственно, базы из $workdir/basejail)
<hr>
<pre>
mkhostsfile="1";
</pre>
Поправить ли в /etc/hosts клетки запись вида
<br>$ip4_add $jname $jname.my.domain
<br>в соответствии с IP адресом и именем (FQDN) клетки
<hr>
<pre>
devfs_ruleset="4";
</pre>
набор правил devfs, которые будут применены на файловую систему devfs в каталоге /dev клетки (список правил в файле /etc/devfs.rules мастер-ноды)
<hr>
<pre>
interface="auto";
</pre>
Запись управляет поведением по автоматическому созданию и удалению IP адресов на интерфейсе либо использованию ранее установленных.
<br>
Значение <b>auto</b> означает, что cbsd сама выберет интерфейс, на котором создать IP адрес клетки. 
Например:  имеется нода с двумя интерфейсами. На интерфейсе igb0 установлен IP и подсеть 10.0.0.2/24 и при этом
шлюз по-умолчанию для сервера является 10.0.0.1, в следствии чего igb0 является сетевой картой, через который идет трафик по-умолчанию. 
<br>На интерфейсе 
igb1 прописан IP/подсеть 192.168.0.1/24. В случае, если в rc.conf клетки ip4_addr принимает значение 192.168.0.{1-255}, то cbsd автоматически выберет
интерфейс igb1 для прописывания IP клетки. 
<br>Если ни на одном из интерфейсов нет подсети, в которую входит IP клетки, будет выбран интерфейс по-умолчанию.
<br>Также, значение может быть выставлено в имя интерфейса, если вы не хотите использовать поиск наиболее подходящего интерфейса. Например запись
<br>
<br>interface="igb0"
<br>
<br>пропишет IP адрес клетки на интерфейсе igb0.
<br>
<br>Также как и при запуске, когда cbsd пропишет на интерфейсе нужные клетке IP, при остановке их снимет с интерфейса. Поэтому, будьте предельно аккуратны - 
если вы пропишите по ошибке в качестве IP клетки адрес непосредственно ноды, то при остановке клетки cbsd выполнит
<br>
<br>ifconfig <iface> <ip> -alias
<br>
<br>и нода будет потеряна по сети.
<br>
<br>Для того, чтобы пресечь управление IP адресами, параметр interface можно закомментировать или удалить, либо значение оставить пустым:
<br>
<br>interface=""
<br>
В этом случае, cbsd сразу будет запускать jail с соответствующим IP, подразумевая, что он уже инициализирован. Такая ситуация может быть необходима, когда
сервер имеет лишь 1 IP адрес, а вы планируете запустить jail (или несколько клеток) на одном имеющимся IP, но с сервисами внутри, которые не конфликтуют
по портам.
<br>Например, имея 1 IP адрес, вы можете запустить одну клетку с WEB сервером на 80 порту, другую клетку с почтовым сервером на 25 порту и тд.
<hr>
<pre>
ver="10.0";
</pre>
Версия базы для клетки. Имеет прямое отношение к версии FreeBSD. Так, если в rc.conf клетки установлены параметры
<br>
<br>arch="amd64"
<br>ver="10.0"
<br>baserw=0
<br>
<br>то при старте клетки в качестве базы будет выбрана ${workdir}/basejail/base_amd64_10.0.
<br>
<br>Если стоит 
<br>
<br>arch="i386"
<br>ver="9.1"
<br>baserw=0
<br>
<br>то, соответственно, будет использован ${workdir}/basejail/base_i386_9.1.
<br>
<br>Таким образом вы можете переключать версию базы с одной версии на другую
<br>
<br>В случае, когда baserw=1, подразумевается что вся база уже была проинициализирована и наполнила собой ${workdir}/jails-data/$jname-data, поэтому эти параметры
роли не играют
<hr>
<pre>
basename="";
</pre>
<br>Имя базы. Вы можете собирать кастомизированные base, например собрать минимальное окружение и разместить его в 
<br>$workdir/base_lite_amd64_9.2
<br>
<br>Для того, чтобы указать cbsd что нужно смонтировать данный каталог, basename должен содержать префикс lite:
<br>
<br>basename="lite";
<hr>
<pre>
baserw="0";
</pre>
Если 1, подразумевается что клетка имеет свою собственную базовую файловую систему и имеет в нее запись. 
<br>Как правило, этот параметр задается на этапе создания клетки. Если же вы создали изначально клетку baserw=0 (readonly), но хотите
перевести ее в режим baserw=1, вам предварительно необходимо скопировать все базовые файлы в каталог $workdir/jails-data/$jname-data. Например:
<br>
<br>cd /usr/jails/basejail/base_amd64_10/
<br>pax -p eme -X -rw . /usr/jails/jails-data/jail1-data
<br>
<br>либо, если вы собрали в мастер-ноде объектные файлы:
<br>make -C /usr/src installworld DESTDIR="/usr/jails/jails-data/jail1-data"
<br>
<br>Таким же образом на данном этапе, предполагается обновлять клетки, работающие в режиме baserw=1, тк каждая клетка имеет персональную копию базы.
<br>Напротив, при использовании baserw=0, вы можете использовать лишь одну копию базы, которая монтируется через nullfs в read-only всем клеткам. 
<br>
<br>Вы можете иметь одну базу (например минимального объема с именем lite) на несколько десятков клеток, размещенную на md-ramfs для ускорения работы базовых утилит в клетках.
<br>
<br>Помимо этого, с baserw=0 вы имеете возможность обновлять версию баз меньшими затратами.
<br>
<br>Кроме этого, смонтированная база в режиме read-only дает вам дополнительную безопасность, если вашу клетку взломали и попробуют модифицировать файлы системы - это у взломщиков просто не получится.
<hr>
<pre>
mount_src="0";
</pre>
Смонтировать ли в /usr/src каталог клетки исходные коды FreeBSD в read-only, если они есть
<hr>
<pre>
mount_obj="";
</pre>
Смонтировать ли в /usr/obj каталог клетки объектные файлы FreeBSD в read-only, если они есть
<hr>
<pre>
mount_kernel="0";
</pre>
Смонтировать ли в /boot/kernel ядро FreeBSD. Это может быть полезно, к примеру, для работы CTF-информации, необходимую для работы DTRACE.
<hr>
<pre>
mount_ports="1";
</pre>
Смонтировать ли в /usr/ports порты из мастер-ноды в readonly. Вы можете иметь одно дерево портов на всю ноду, которое развернуть в /usr/ports каталоге мастер-ноды и которое подмонтировано во все клетки.
<br>Для того, чтобы одновременная копмиляция одного и того же порта не конфликтовала в двух и более клетках, в /etc/make.conf параметр WRKDIRPREFIX ставится в альтернативное место, например /tmp (если клетка 
имеет applytpl=1, это происходит автоматически)
<hr>
<pre>
astart="1";
</pre>
Следует ли запускать клетку автоматически при старте ноды. Если astart=0, клетка не запустится сама с перезагрузки мастер-хоста.
<hr>
<pre>
vnet="0";
</pre>
<hr>
<pre>
applytpl="1";
</pre>
Применить ли некоторые модификации в конфигурации клетки: выставить pkg.conf, внести записи в /etc/hosts и тд.
<hr>
<pre>
mdsize="0";
</pre>
<hr>
<pre>
rcconf="/usr/jails/jails-rcconf/rc.conf_jail1";
</pre>
<hr>
<pre>
floatresolv="1";
</pre>
Автоматически поправить /etc/resolv.conf , назначив автоматически в качестве первичного nameserver кеширующий named в мастер-ноде, остальные nameserver - из инвентаризации  ноды.
<hr>
<pre>
exec_start="/bin/sh /etc/rc";
</pre>
<hr>
<pre>
exec_stop="/bin/sh /etc/rc.shutdown";
</pre>
<hr>
<pre>
exec_poststart="";
</pre>
Выполнить команду внутри клетки после ее старта. Можно задавать несколько скриптов нумерую параметры:
<br>
<br>exec_poststart0="date > /tmp/start1.txt";
<br>exec_poststart1="date > /tmp/start2.txt";
<br>..
<hr>
<pre>
exec_poststop="";
</pre>
Выполнить команду внутри клетки после ее останова. Можно задавать несколько скриптов нумерую параметры:
<br>
<br>exec_poststop0="date > /tmp/stop1.txt";
<br>exec_poststop1="date > /tmp/stop2.txt";
<br>..
<hr>
<pre>
exec_prestart="";
</pre>
Выполнить команду внутри клетки перед ее стартом. Можно задавать несколько скриптов нумерую параметры:
<br>
<br>exec_prestart0="date > /tmp/prestart1.txt";
<br>exec_prestart1="date > /tmp/prestart2.txt";
<br>..
<hr>
<pre>
exec_prestop="";
</pre>
Выполнить команду внутри клетки перед ее остановом. Можно задавать несколько скриптов нумерую параметры:
<br>
<br>exec_prestop0="date > /tmp/prestop1.txt";
<br>exec_prestop1="date > /tmp/prestop2.txt";
<br>..
<hr>
<pre>
exec_master_poststart="";
</pre>
Аналогичное поведение exec_poststart, за исключением того что команда выполняется в мастер системе (будьте внимательны, небезопасно)
<hr>
<pre>
exec_master_poststop="";
</pre>
Аналогичное поведение exec_poststop, за исключением того что команда выполняется в мастер системе (будьте внимательны, небезопасно)
<hr>
<pre>
exec_master_prestart="";
</pre>
Аналогичное поведение exec_prestart, за исключением того что команда выполняется в мастер системе (будьте внимательны, небезопасно)
<hr>
<pre>
exec_master_prestop="";
</pre>
Аналогичное поведение exec_prestop, за исключением того что команда выполняется в мастер системе (будьте внимательны, небезопасно)
</body>
</html>
