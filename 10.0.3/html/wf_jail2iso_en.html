<b>Command</b>:<br>
<pre>
% cbsd jail2iso
</pre>
<b>Description</b>:
<br><br>
The <b>jail2iso</b> script allows to create a bootable image for CD/DVD/Memstick or <b>bhyve</b> hypervisor from the specified jail.
Despite the fact that functional <b>jail2iso</b> is not used in <b>cbsd</b> operation or jails, this script 
can be very useful for easy and comfortable build customized LiveCD, content which you can install, 
configure and test in jail. For example, this functionality is useful for:
<br><br>
<li> Creating rescue-system with necessary tools
<li> Building your own FreeBSD distribution
<li> Creating images for diskless servers/stations (eg booted from PXE, MicroSD, Flash, CD/DVD, etc.) and have mounted home directories or jails/data files 
from NFS/FibreChannel/iSCSI/InfiniBand.
<li> Transfer environment from jail to bhyve image for using features of <b>bhyve</b> (and loss features of jail)
<br><br>
<h3>Script job for iso/memstick</h3>
<br>
<li> Creation of file hierarchy of next image consisting of mounted base and data of a jail
<li> Creation of MFS/UZIP of an image which will remain in memory. It is used generally for work acceleration in the LiveCD mode, allowing for "cache" often caused utilities and libraries, for example
from / to / usr.
<li> Mount over MFS of hierarchy of data from file system of the media through nullfs/RO
<li> Mount through tmpfs over RO file system for modification in LiveCD mode.
<br>
<br>
If you need a number of directories reload when loading image in RW via tmpfs, before executing <b>jail2iso</b> you needs to be written to a file 
<i>$systemdir/jail/tmpfsdir</i> all the path
<br>For example <b>rescuebsd</b> jail is a file: <i>/usr/jails/jails-system/rescuebsd/tmpfsdir</i> with content:
<br>
<pre>
/root
/var/run
/var/cache
/var/db
/var/spool
/var/log
/usr/home
/usr/local/etc
</pre>
<br>
These entries are processed <i>/etc/rc.d/tmpfsdir</i>, which will save to the image by <b>jail2iso</b>. 
All contents of these files, which is on the jail, will be moved to tmpfs filesystem.
<br>As RW areas are mounted through TMPFS, the quantity of memory available to record will depend on quantity of RAM of servers on which LiveCD is started.
<br><br>
You may prefer to write your own /boot/loader.conf to created image. 
To do this, save the file <b>loader.conf</b> in the directory <i>$systemdir/$jname/</i>. 
Everything you write in this file will be added to loader.conf, generated <b>jail2iso</b>, which has the following mandatory entries:
<pre>
kern.ipc.shmmni=4096
kern.ipc.shmseg=4096
radeonkms_load="YES"
i915kms_load="YES"
linux_load="YES"
</pre>
<br>
You can specify what type of image <b>jail2iso</b> is to create, ISO image with cd9960 for CD/DVD/VMs or Memstick, an image that you can burn to a USB Flash drive.
<br>
<h3>Script job for bhyve image</h3>
<br>
Since the image will be initially bhyve mode RW, it does not require the creation of RO image with UZIP and support tmpfsdir, so at this stage there is no formation of an image.
The script will automatically create a fstab-entry to mount an appropriate device in bhyve machine and updates /etc/ttys as required <a href="http://people.freebsd.org/~neel/bhyve/bhyve_instructions.txt">instructions</a>.
<br>
When creating an image bhyve, use the parameter:
<pre>
% cbsd jail2iso ... imgsize=
</pre>
Because without this option, create disk volume equal to the volume of evidence, without reserve. This will make the system broken, so through <b>imgsize=</b> specify the size always known 
greater than the current data volume in jail
<br>
<h3>For more information</h3>
<br><b>cbsd jail2iso</b> is not controlled and does not limit the volume of the final result - they are limited only by your destination media:
<br><br>
For create ISO image use:
<pre>
%  cbsd jail2iso media=iso ..
</pre>
For create memstick image use:
<pre>
% cbsd jail2iso media=memstick ..
</pre>
For create bhyve image use:
<pre>
% cbsd jail2iso media=bhyve imgsize=XXg ..
</pre>
<br>
Directory where to save the image specified as an argument <b>dstdir</b>.
<br>
By default, the image will be have GENERIC kernel from $workdir/basejail/ directory. 
You can get this kernel via
<br>
<pre>% cbsd repo action=get sources=kernel</pre>
for your version of FreeBSD, or build it yourself through <b>cbsd buildkernel</b>.
 If the GENERIC kernel is not suitable as an argument <b>name</b> for <b>jail2iso</b> 
you can specify a different kernel if you have it.
<br><br>
In addition, to reduce the size of the final image, jail2iso a series of actions:<br>
<br>
<li> removal .a-archive files in lib directories
<li> removing unnecessary data by file list
<br>
<br> By default, this list is located in the $workdir/share/jail2iso-prunelist.
You can correct them if you needed, or create your own, specifying the path to it as an argument <b>prunelist</b>
<br><br>
Example of creating memstick from jail1:
<br><pre>
% cbsd jail2iso media=memstic jname=jail dstdir=/tmp
</pre>
If the file /tmp/jail1.img created, it can be writte to a USB device via the command:
<pre>
dd if=/tmp/mc.img of=/dev/da0 bs="10240" conv="sync"
</pre>
, where <b>/dev/da0</b> - is USB Flash storage.
<br><br>
Example of creating and launching bhyve image from jail1 with networks via interface <b>em0</b>:
<pre>
% cbsd jail2iso media=bhyve jname=jail1 dstdir=/tmp imgsize=5g
% kldload vmm
% kldload if_tap
% sysctl -w net.link.tap.up_on_open=1
% ifconfig tap0 create
% ifconfig bridge0 create
% ifconfig bridge0 addm em0 addm tap0
% ifconfig bridge0 up
% sh /usr/share/examples/bhyve/vmrun.sh -d /tmp/jail1-10.0_amd64.img vm1 
</pre>
where <b>/tmp/jail1-10.0_amd64.img</b> - result from jail2iso.
<br><br><center>
