<!--# include file="_start.html" -->
<!--# include file="currentver.html" -->
<!--# include file="/en/translate.html" -->
<h1><span>Bhyve via cbsd scripts howto</span></h1>
<h2><a name="intro"><span>howto</span></a></h2>
<div class="block">
	<p>This is a quick howto if you want to experiment with bhyve through cbsd</p>
	<p>install dependencies <strong>CBSD</strong>:</p>
	<pre class="brush:bash;ruler:true;">
		% make -C /usr/ports/net/rsync install
		% make -C /usr/ports/security/sudo install
		% make -C /usr/ports/databases/sqlite3 install
		% make -C /usr/ports/security/libssh2 install
	</pre>
	<p>Get cbsd scripts and bring them in working condition:</p>
	<pre class="brush:bash;ruler:true;">
		% git clone https://github.com/olevole/cbsd.git /usr/local/cbsd
		% pw useradd cbsd -s /bin/sh -d /nonexistent -c "cbsd user"
		% cd /usr/local/etc/rc.d
		% ln -s /usr/local/cbsd/rc.d/cbsdd
		% ln -s /usr/local/cbsd/rc.d/cbsdrsyncd
		
		% env workdir="/usr/jails" /usr/local/cbsd/sudoexec/initenv
		//answer a couple of stupid questions from http://www.bsdstore.ru/en/installing_cbsd.html
	</pre>
	<p>Creation of VMs:</p>
	<pre class="brush:bash;ruler:true;">
		% cbsd bconstruct-tui
	</pre>
	<ul>
		<li><b>vm_os_type</b> - freebsd или linux (correct operation of other OSs while under suspicion)</li>
		<li><b>vm_os_profile</b> - if Linux, select linux through space profile.</li>
		<li><b>freesize</b> - volume of VHD. If guest is Linux, it will be the total size of the entire disk. If this is FreeBSD, it is the amount of free space available after creation (created out of jail). For example: <strong>10g</strong> for Linux or <strong>1g</strong> for FreeBSD</li>
		<li><b>jname</b> - имя виртуалки. например: freebsd, ubuntu, centos, debian</li>
		<li><b>fqdn</b> - полное имя с доменом, например blabla_foo.my.domain</li>
	</ul>
	<p>The remaining parameters are optional. For FreeBSD virtual ok can immediately fill <strong>ip4_addr</strong>  (for example: 192.168.0.5/24) and <strong>gw4</strong> (for example: 192.168.0.1) - by design, it will apply to the newly created VM. If Linux, <strong>ip4_addr</strong> leave it set to 0, <strong>gw4</strong> - empty.</p>
	<p>After working bconstruct-tui can try to run through <strong>cbsd bstart $jname</strong>. By default, run from the hard disk image (order is hardcoded for a while), but if the image is blank, should try to start with the CD/ISO.</p>
	<p>Running as it should now bhyve, takes place in two stages - booting the kernel through <strong>bhyveload</strong> (in foreign, not FreeBSD-guests, this operation goes through <strong>grub2-bhyve</strong>) directly and through the launch of virtuality <strong>bhyve</strong>. Both in the case of operations taking place in cbsd <strong>tmux</strong> session and if after working <strong>cbsd bstart</strong> you returned to the terminal and if the command <strong>cbsd bls</strong> show status On for the guest, likely kernel booted successfully and can connect to the console via its <strong>cbsd blogin $jname</strong>.</p>
	<p>If you are logged inherited navigation tmux - the main thing that you need in the case of <strong>cbsd</strong> know about tmux, that the operation of the terminal shutdown occurs through a combination of <strong>Ctrl + B</strong>  and <strong>D</strong> (hold Ctrl, press B. let them push and D). Stoping VMs (as well as the completion of bhyveload if it hangs and you are not released back to the terminal at <strong>bstart</strong>) via a command <strong>cbsd bstop $jname</strong></p>
	<p>Couple of comments:</p>
	<ul>
		<li> FreeBSD guest created through the script jail2iso of jail, so it does not offer starts with ISO</li>
		<li> Network for VMs created through tap-interfaces that are attached to in your uplink interface via bridge</li>
		<li> If you want to add a couple of disks in VMs see <a href="https://github.com/olevole/cbsd/blob/master/share/local-bhyvedsk.schema" target="_blank">schema</a> of bhyvedsk table for <em>$workdir/var/db/local.sqlite</em> file - adding new records to the table corresponding VMs, they will connect automatically at startup. Later, some will be written to this interface.</li>
		<li> When "rubber" of the data on the screen on a widescreen monitor, if the amount is more than 255 familiarity, grub goes into a stupor and leads to the same bhyveload. For example on my monitor <a href="http://www.olevole.ru/normal_grub2.png" _target="_blank">http://www.olevole.ru/normal_grub2.png</a> if konsole stretch one more familiarity and restart bhyveload, he starts eating 100% cpu. Most likely a bug in grub and FreeBSD/bhyve users is first people who start grub on widescreen in high resolution and text mode. Accordingly, if cbsd bstart XXX process is locked, follow cbsd bstop XXX and reducing the window geometry, try to run again.
		Comment on this behavior from <strong>Peter Grehan</strong> (creator of grub-bhyve port/project):
		<pre class="cli">
		Thanks for the detailed report: looks like this may not be too 
		difficult to fix in grub-bhyve i.e. limit the max terminal size to 255.

		> I suggest to add pkg-message for sysutils/grub2-bhyve with "Known issue: ..."
		> for this feature if you find the same behavior on the wide display.
		> PS: as I understand it, grub-bhyve - this is a temporary solution for OS boot?

		Yes - it's really a proof-of-concept that bhyve can run non-FreeBSD 
		guests. The solution currently being worked on is to use the OVMF build 
		of UEFI as a boot ROM, rather than having a separate user-space boot loader.
		</pre>
		</li>
		<div>
<!--# include file="_end.html" -->